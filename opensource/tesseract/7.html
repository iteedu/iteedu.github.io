<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end -->
<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->

  <h1>Tesseract-ocr项目功能模块的实现</h1>
<p><strong>站长原创，版权所有<a href="http://www.iteedu.com/index.html">ITEEDU</a>，2011-07-16</strong></p>
<p>在进行测试的过程中，由于处于摸索和学习的阶段，所以在实现图片文字识别过程中，曾经历了好几个版本，下边简单地做以讲解。</p>
<h2><a name="t-1" id="t-1"></a>第一阶段：通过命令端测试</h2>
安装完毕后，设置好环境变量，我是建立了一个ocr.sh文件，每次执行一下子：source ocr.sh即可。 <pre class="code">#!bin/bash
export  /home/administrator/tesseract-ocr/bin:
export  /home/administrator/tesseract-ocr/lib:</pre>
  在终端输入
  <pre class="code">tesseract   picture1.tif  5   -l   chi_sim</pre>
即可将图片picture1.tif中的文字信息提取出来，并放在5.txt文件中。
  <h2><a name="t-2" id="t-2"></a>第二阶段：结果输出到终端</h2>
<p>在测试阶段，我在eclipse中，修改了tesseract-ocr源码中的tesseractmain.cpp函数，得出了自己的程序代码，具体代码：</p>
<pre class="code">//读取图片，分析图片，提取其中的文字内容，输出到终端上来
  #include &lt;ctype.h&gt;
  #include &quot;applybox.h&quot;
  #include &quot;control.h&quot;
  #include &quot;tessvars.h&quot;
  #include &quot;tessedit.h&quot;
  #include &quot;baseapi.h&quot;
  #include &quot;thresholder.h&quot;
  #include &quot;pageres.h&quot;
  #include &quot;imgs.h&quot;
  #include &quot;varabled.h&quot;
  #include &quot;tprintf.h&quot;
  #include &quot;tesseractmain.h&quot;
  #include &quot;stderr.h&quot;
  #include &quot;notdll.h&quot;
  #include &quot;mainblk.h&quot;
  #include &quot;output.h&quot;
  #include &quot;globals.h&quot;
  #include &quot;helpers.h&quot;
  #include &quot;blread.h&quot;
  #include &quot;tfacep.h&quot;
  #include &quot;callnet.h&quot;
  #include &quot;strings.h&quot;
  #include   &quot;varable.h&quot;
  #include   &quot;tessclas.h&quot;
  #include   &quot;notdll.h&quot;
  #ifdef USING_GETTEXT
  #include &lt;libintl.h&gt;
  #include &lt;locale.h&gt;
  #define _(x) gettext(x)
  #else
  #define _(x) (x)
  #endif
  #ifdef HAVE_LIBTIFF
  #include &quot;tiffio.h&quot;
  #endif
  #ifdef HAVE_LIBLEPT
  #include &quot;allheaders.h&quot;
  #else
  class Pix;
  #endif
  #ifdef _TIFFIO_
  void read_tiff_image(TIFF* tif, IMAGE* image);
  #endif
  const int kMaxIntSize = 22;
  char szAppName[] = &quot;Tessedit&quot;;   //app name
  #define EXTERN
  BOOL_VAR(tessedit_create_boxfile, FALSE, &quot;Output text with boxes&quot;);
  BOOL_VAR(tessedit_create_hocr, FALSE, &quot;Output HTML with hOCR markup&quot;);
  BOOL_VAR(tessedit_read_image, TRUE, &quot;Ensure the image is read&quot;);
  INT_VAR(tessedit_serial_unlv, 0,
  &quot;0-&gt;Whole page, 1-&gt;serial no adapt, 2-&gt;serial with adapt&quot;);
  INT_VAR(tessedit_page_number, -1,
  &quot;-1 -&gt; All pages, else specific page to process&quot;);
  BOOL_VAR(tessedit_write_images, FALSE, &quot;Capture the image from the IPE&quot;);
  BOOL_VAR(tessedit_debug_to_screen, FALSE, &quot;Dont use debug file&quot;);

/*
  convert the input_file into the STRING*,and put it into the text_out
  */

  void TesseractImage(const char* input_file, IMAGE* image, Pix* pix, int page_index,
  tesseract::TessBaseAPI* api, STRING* text_out) {
  api-&gt;SetInputName(input_file);
  #ifdef HAVE_LIBLEPT
  if (pix != NULL) {
  api-&gt;SetImage(pix);
  } else {
  #endif
  int bytes_per_line = check_legal_image_size(image-&gt;get_xsize(),
  image-&gt;get_ysize(),
  image-&gt;get_bpp());
  api-&gt;SetImage(image-&gt;get_buffer(), image-&gt;get_xsize(), image-&gt;get_ysize(),
  image-&gt;get_bpp() / 8, bytes_per_line);
  #ifdef HAVE_LIBLEPT
  }
  #endif
  if (tessedit_serial_unlv == 0) {
  char* text;
  if (tessedit_create_boxfile)
  text = api-&gt;GetBoxText(page_index);
  else if (tessedit_write_unlv)
  text = api-&gt;GetUNLVText();
  else if (tessedit_create_hocr)
  text = api-&gt;GetHOCRText(page_index + 1);
  else
  text = api-&gt;GetUTF8Text();
  *text_out += text;
  delete [] text;
  } else {
  BLOCK_LIST blocks;
  STRING filename = input_file;
  const char* lastdot = strrchr(filename.string(), '.');
  if (lastdot != NULL) {
  filename[lastdot - filename.string()] = '\0';
  }
  if (!read_unlv_file(filename, image-&gt;get_xsize(), image-&gt;get_ysize(),
  &amp;blocks)) {
  fprintf(stderr, _(&quot;Error: Must have a unlv zone file %s to read!\n&quot;),
  filename.string());
  return;
  }
  BLOCK_IT b_it = &amp;blocks;
  for (b_it.mark_cycle_pt(); !b_it.cycled_list(); b_it.forward()) {
  BLOCK* block = b_it.data();
  TBOX box = block-&gt;bounding_box();
  api-&gt;SetRectangle(box.left(), image-&gt;get_ysize() - box.top(),
  box.width(), box.height());
  char* text = api-&gt;GetUNLVText();
  *text_out += text;
  delete [] text;
  if (tessedit_serial_unlv == 1)
  api-&gt;ClearAdaptiveClassifier();
  }
  }
  if (tessedit_write_images) {
  page_image.write(&quot;tessinput.tif&quot;);
  }
  }
/*end TesseractImage*/
/*Ocr  * */
  char* Ocr(const char *input,char *output,const char* lang){
  lang = &quot;eng&quot;;
  tesseract::TessBaseAPI  api;
  api.Init(input,lang, 0, 0, false);
  IMAGE image;
  STRING text_out;
  int page_number = tessedit_page_number;
  if (page_number &lt; 0){
  page_number = 0;
  }
  FILE* fp = fopen(input, &quot;rb&quot;);
  if (fp == NULL) {
  tprintf(_(&quot;Image file %s cannot be opened!\n&quot;),input);
  fclose(fp);
  exit(1);
  }
 #ifdef HAVE_LIBLEPT
  int page = page_number;
  int npages = 0;
  bool is_tiff = fileFormatIsTiff(fp);
  if (is_tiff) {
  int tiffstat = tiffGetCount(fp, &amp;npages);
  if (tiffstat == 1) {
  fprintf (stderr, _(&quot;Error reading file %s!\n&quot;),input);
  fclose(fp);
  exit(1);
  }
  //fprintf (stderr, &quot;%d pages\n&quot;, npages);
  }
  fclose(fp);
  fp = NULL;
  Pix *pix;
  if (is_tiff) {
  for (; (pix = pixReadTiff(input, page)) != NULL; ++page) {
  if (page &gt; 0)
  tprintf(_(&quot;Page %d\n&quot;), page);
  char page_str[kMaxIntSize];
  snprintf(page_str, kMaxIntSize - 1, &quot;%d&quot;, page);
  api.SetVariable(&quot;applybox_page&quot;, page_str);
 // Run tesseract on the page!
  TesseractImage(input, NULL, pix, page, &amp;api, &amp;text_out);
  pixDestroy(&amp;pix);
  if (tessedit_page_number &gt;= 0 || npages == 1) {
  break;
  }
  }
  } else {
  // The file is not a tiff file, so use the general pixRead function.
  // If the image fails to read, try it as a list of filenames.
  PIX* pix = pixRead(input);
  if (pix == NULL) {
  FILE* fimg = fopen(input, &quot;r&quot;);
  if (fimg == NULL) {
  tprintf(_(&quot;File %s cannot be opened!\n&quot;), input);
  fclose(fimg);
  exit(1);
  }
  char filename[MAX_PATH];
  while (fgets(filename, sizeof(filename), fimg) != NULL) {
  chomp_string(filename);
  pix = pixRead(filename);
  if (pix == NULL) {
  tprintf(_(&quot;Image file %s cannot be read!\n&quot;), filename);
  fclose(fimg);
  exit(1);
  }
  tprintf(_(&quot;Page %d : %s\n&quot;), page, filename);
  TesseractImage(filename, NULL, pix, page, &amp;api, &amp;text_out);
  pixDestroy(&amp;pix);
  ++page;
  }
  fclose(fimg);
  } else {
  TesseractImage(input, NULL, pix, 0, &amp;api, &amp;text_out);
  pixDestroy(&amp;pix);
  }
  }
  #else
  #ifdef _TIFFIO_
  int len = strlen(input);
  TIFF* archive = NULL;
  do {
  // Since libtiff keeps all read images in memory we have to close the
  // file and reopen it for every page, and seek to the appropriate page.
  if (archive != NULL)
  TIFFClose(archive);
  archive = TIFFOpen(input, &quot;r&quot;);
  if (archive == NULL) {
  tprintf(_(&quot;Read of file %s failed.\n&quot;), input);
  exit(1);
  }
  if (page_number &gt; 0)
  tprintf(_(&quot;Page %d\n&quot;), page_number);
 // Seek to the appropriate page.
  for (int i = 0; i &lt; page_number; ++i) {
  TIFFReadDirectory(archive);
  }
  char page_str[kMaxIntSize];
  snprintf(page_str, kMaxIntSize - 1, &quot;%d&quot;, page_number);
  api.SetVariable(&quot;applybox_page&quot;, page_str);
  // Read the current page into the Tesseract image.
  IMAGE image;
  read_tiff_image(archive, &amp;image);
 // Run tesseract on the page!
  TesseractImage(input, &amp;image, NULL, page_number, &amp;api, &amp;text_out);
  ++page_number;
  // Do this while there are more pages in the tiff file.
  } while (TIFFReadDirectory(archive) &amp;&amp;
  (page_number &lt;= tessedit_page_number || tessedit_page_number &lt; 0));
  TIFFClose(archive);
  } else {
  #endif
  // Using built-in image library to read bmp, or tiff without libtiff.
  if (image.read_header(input) &lt; 0) {
  tprintf(_(&quot;Read of file %s failed.\n&quot;), input);
  exit(1);
  }
  if (image.read(image.get_ysize ()) &lt; 0)
  MEMORY_OUT.error(&quot;error&quot;, EXIT, _(&quot;Read of image %s&quot;), input);
  invert_image(&amp;image);
  TesseractImage(input, &amp;image, NULL, 0, &amp;api, &amp;text_out);
  #ifdef _TIFFIO_
  }
  delete[] ext;
  #endif
  #endif  // HAVE_LIBLEPT
 char outs[900];
  //output =(char*)malloc(strlen(text_out.string())+1);
  output=outs;
  memset(output,0,sizeof(output));
  strcpy(output,text_out.string());
  //free(output);
  return output;                      //Normal exit
  }
//main
  int main(int argc,char ** argv){
  const char* input=&quot;/home/administrator/donate.tif&quot;;
  char * outs= 0;
  outs=Ocr(input,outs,&quot;eng&quot;);
  while(outs!=NULL){
  printf(&quot;%c&quot;,*outs);
  outs++;
  }
  return 0;
  }</pre>
<h2><a name="t-3" id="t-3"></a>第三阶段：通过其他途径传递过来的参数</h2>
最后，一阶段，最终实现了，我们想要想要的功能，而且就那么简单的几行：
 <pre class="code">//初始化,读取图片，生成image对象，通过image对象获取图片的相关参数，调用//提取图片文字信息的接口函数 
  <strong>#include</strong> &quot;tessedit.h&quot;
  <strong>#include</strong> &quot;baseapi.h&quot;
  <strong>#include</strong> &quot;imgs.h&quot;
  <strong>#include</strong> &quot;varabled.h&quot;
  <strong>#include</strong> &quot;tprintf.h&quot;
  <strong>#include</strong> &quot;tesseractmain.h&quot;
  <strong>#include</strong> &quot;stderr.h&quot;
  <strong>#include</strong> &quot;tessvars.h&quot;
  <strong>#include</strong> &lt;MagickWand.h&gt;
  //#include  &lt;MagickCore.h&gt;
  <strong>#include</strong> &quot;convert.h&quot;</p>
<p align="left"><strong>#define</strong> _(x) (x)
  <strong>char</strong> *<strong>ocr</strong>(<strong>char</strong> *input,<strong>char</strong> *output)
  {
  tesseract::TessBaseAPI  api;
  <strong>const</strong> <strong>char</strong>* lang = &quot;eng&quot;;          //eng为英文包，chi_sim为汉文包 
  api.<strong>Init</strong>(&quot;/tmp&quot;,lang, 0, 0, <strong>false</strong>);//init the  language
  api.<strong>SetPageSegMode</strong>(tesseract::<em>PSM_AUTO</em>);//设置自动进行版面分析 
  IMAGE image;  //在这里只是为了测试，所以还是从读取图片开始 
  <strong>if</strong> (image.<strong>read_header</strong>(input) &lt; 0) {//读取文件中的元信息 
  <strong>tprintf</strong>(_(&quot;Read of file %s  failed.\n&quot;), input);
  <strong>exit</strong>(1);
  }
  <strong>if</strong> (image.<strong>read</strong>(image.get_ysize ()) &lt;  0)
  MEMORY_OUT.<strong>error</strong>(&quot;test&quot;, EXIT, _(&quot;Read of image  %s&quot;),  input);
  <strong>invert_image</strong>(&amp;image);
//图片读取结束，获取调用ocr接口所需要的参数 
  <strong>const</strong> <strong>unsigned</strong> <strong>char</strong>* imagedata =  image.get_buffer();
  <strong>int</strong> bits_per_pixel =  image.get_bpp()/8;
  <strong>int</strong> bytes_per_line = <strong>check_legal_image_size</strong>(image.get_xsize(),  image.get_ysize(),
  image.get_bpp());
  <strong>int</strong> xsize =  image.get_xsize();
  <strong>int</strong> ysize =  image.get_ysize();
  //所需要的参数中left和top为0，代表从最左，最顶开始转换图片 
  //get.bpp(),return bits  per pixel
  //get.bpp()/8,return bytes per pixel
  //调用ocr接口函数，并输出我们需要的字符串 
  output=api.<strong>TesseractRect</strong>(imagedata,  bits_per_pixel,
  bytes_per_line, 0, 0,
  xsize,  ysize);
  <strong>return</strong> output;
  }
  <strong>int</strong> <strong>main</strong>(<strong>int</strong> argc,<strong>char</strong> **argv) {
 <strong>char</strong> *input = &quot;/home/administrator/tmp.bmp&quot;;
  <strong>char</strong> *output =NULL;
  output = ocr(input,output);
  <strong>printf</strong>(&quot;%s&quot;,output);
  <strong>delete</strong> []output;
  <strong>return</strong> 0;                      //Normal exit
  }
  /*函数原型 
  * char* TessBaseAPI::TesseractRect(const unsigned char* imagedata,
  int bytes_per_pixel,
  int bytes_per_line,
  int left, int top,
  int width, int height)；*/</pre>
<h2>tesseract-ocr源码官方网站</h2>
http://tesseract-ocr.googlecode.com/svn/trunk/api/<br />
  有用的api函数的实现，呵呵 <br />
http://tesseract-ocr.repairfaq.org/main.html<br />
  其他api查找首页 <br />
</p>
<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
