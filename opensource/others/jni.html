<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end -->
<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->

  <h1> JNI的体验</h1>
  <p><strong>站长原创，版权所有<a href="http://www.iteedu.com/index.html">ITEEDU</a>，2011-07-29</strong></p>
  <p>进入公司之后，由我单独负责处理ocr模块，在研究了一周之后，我觉着自己用cpp去调用tesseract-ocr接口函数，我们需呀的功能实现之后，得给他们java那边去调用呀，于是想到了java怎样才能调用我的cpp程序呢？ </p>
  <h2>与项目相关的初步设想 </h2>
  <p >在tesseract-ocr安装目录中： </p>
  <p >Bin：一些工具和命令； </p>
  <p >Include：一些头文件； </p>
  <p >Lib：一些库文件； </p>
  <p >Share：配置文件和需要的语言包。  </p>
<p >我们需要调用的接口函数就在include中，编译、运行时所需要的库就在lib中。 </p>
  <p >而tesseract-ocr源码编译所生成的.so文件有很多，我们需要一个自己编写一个调用这些接口的函数。这个函数是通过JNI机制实现的。 </p>
  <p >（1）首先编写一个.java文件，testJNI.java。 </p>
  <p >其主要功能在该类中定义一个&#160;public&nbsp;native&nbsp;void&nbsp;Tesseract(int&nbsp;argc,String[]&nbsp;args) </p>
  <p >（2）利用javac将该类编译成.class文件 </p>
  <p >（3）利用javah将.class编译成.h文件。 </p>
  <p >（4）利用c++来实现在java类中所定义的native函数，形成.cpp文件。 </p>
  <p >（5）g++和JNI机制，将.cpp编译成.o文 </p>
  <p >（6）将.o文件编译成.so文件。 </p>
  <p >这样子，我们就可以直接利用Java来调用这个.so文件了。 </p>
  <h2 >什么是&nbsp;JNI </h2>
  <p >&nbsp;&nbsp;&nbsp;&nbsp;JNI是Java&nbsp;Native&nbsp;Interface的缩写。从Java&nbsp;1.1开始，JNI标准成为java平台的一部分，它允许Java和其他语言进行交互。JNI一开始为C和C++而设计的，但是它并不妨碍你使用其他语&nbsp;言，只要调用约定受支持就可以了。使用java与本地已编译的代码交互，通常会丧失平台可移植性。但是，有些情况下这样做是可以接受的，甚至是必须的，比&nbsp;如，使用一些旧的库，与硬件、操作系统进行交互，或者为了提高程序的性能。关于&nbsp;JNI&nbsp;的用法很简单，有点像&nbsp;java&nbsp;里的&nbsp;reflect&nbsp;的工作机制，有兴趣的朋友可以参看Java&nbsp;本地接口规范&nbsp;http://linux.computersci.net/art&nbsp;...&nbsp;pec/jniTOC.doc.html </p>
  <p >Jni程序开发的一般操作步骤如下： </p>
  <p >(1)&nbsp;编写带有native声明的方法的java类 </p>
  <p >(2)&nbsp;使用javac&nbsp;或&nbsp;IDE(JBuilder,eclipse等)编译所编写的java类 </p>
  <p >(3)&nbsp;使用javah&nbsp;-jni&nbsp;java类名生成扩展名为h的头文件 </p>
  <p >(4)&nbsp;使用C++&nbsp;实现本地方法,对调用签名可用&nbsp;javap&nbsp;&#8211;s&nbsp;&#8211;p&nbsp;[类全名]&nbsp;查看（开发&nbsp;C++&nbsp;动态链接库本例是用的&nbsp;VC6） </p>
  <p >注意要从&nbsp;JDK下面的&nbsp;include&nbsp;文件夹中把&nbsp;jni.h和&nbsp;jni_md.h&nbsp;两个文件&nbsp;copy&nbsp;到你的&nbsp;VC&nbsp;工程里 </p>
  <p >(5)&nbsp;在&nbsp;Java&nbsp;中&nbsp;load&nbsp;动态链接库文件，调用&nbsp;native&nbsp;方法. </p>
  <p >或者说将项目依赖的所有原生库和资源加入到java项目的java.library.path，生成java程序。 </p>
  <h2 >简单的JNI测试用例 </h2>
  <p >我们测试都是在linux下边进行的，使用的是Java和C的互相调用，Java提供本地接口，C实现该本地接口。 </p>
  <h3 >(1)&nbsp;Java本地接口 </h3>
  <p >首先，实现的是Java本地接口Hello.java，代码如下所示： </p>
  <pre class="code">class&nbsp;HelloWorld&nbsp;{ 
  &#160;&#160;&#160;&nbsp;public&nbsp;native&nbsp;void&nbsp;sayHello(); 
  &#160;&#160;&#160;&nbsp;static&nbsp;{ 
  &#160;&#160;&#160;&nbsp;&#160;&#160;&#160;&nbsp;System.loadLibrary("HelloWorld"); 
  //注意在Linux下边，需要将库名的头部和尾部去掉，来加载，库名：libHelloWorld.so 
  &#160;&#160;&#160;&nbsp;} 
  &#160;&#160;&#160;&nbsp;public&nbsp;static&nbsp;void&nbsp;main(String[]&nbsp;args)&nbsp;{ 
  &#160;&#160;&#160;&nbsp;&#160;&#160;&#160;&nbsp;(new&nbsp;HelloWorld()).sayHello(); 
  &#160;&#160;&#160;&nbsp;} 
  } </pre>
  <p >其中，方法声明为native，其实HelloWorld类就相当于一个接口，是为其他编程语言声明的接口。System.loadLibrary("HelloWorld");语句是一个static块，也就是在该HelloWorld类加载的时候进行执行。其中，该语句实现了加载本地的动态连接库（DLL），在Linux平台下，动态连接库文件是以.so作为扩展名的，也就是标准对象（Standard&nbsp;Object）。 </p>
  <h3 >(2)&nbsp;对该本地接口类进行编译 </h3>
  <pre class="code">[home@administrator]#&nbsp;javac&nbsp;HelloWorld.java </pre>
  <h3 >(3)&nbsp;生成c语言头文件 </h3>
  <p >接着，通过编译的HelloWorld.class文件，生成C语言的头文件，执行命令： </p>
  
  <p >[home@administrator]#&nbsp;javah&nbsp;-jni&nbsp;HelloWorld </p>
  <p >或者： </p>
  <p >[home@administrator]#&nbsp;javah&nbsp;HelloWorld </p>
  <p >但是，千万别用javah&nbsp;HelloWorld.class，肯定会出错，呵呵，本人就是经历了哦&#8230;&#8230; </p>
  
  <p >可以看到，在当前目录下生成一个HelloWorld.h文件，该文件就是C的接口文件，为使用C实现Java接口中定义的方法，可以发现在HelloWorld.h中有一个方法声明： </p>
  <pre class="code">/*&nbsp;DO&nbsp;NOT&nbsp;EDIT&nbsp;THIS&nbsp;FILE&nbsp;-&nbsp;it&nbsp;is&nbsp;machine&nbsp;generated&nbsp;*/ 
  
  #ifndef&nbsp;__HelloWorld__ 
  #define&nbsp;__HelloWorld__ 
  
  #include&nbsp;&#60;jni.h&#62; 
  
  #ifdef&nbsp;__cplusplus 
  extern&nbsp;"C" 
  { 
  #endif 
  
  JNIEXPORT&nbsp;void&nbsp;JNICALL&nbsp;Java_HelloWorld_sayHello&nbsp;(JNIEnv&nbsp;*env,&nbsp;jobject); 
  
  #ifdef&nbsp;__cplusplus 
  } 
  #endif 
  
  #endif&nbsp;/*&nbsp;__HelloWorld__&nbsp;*/ </pre>
  <h3 >(4)&nbsp;用C实现该native接口 </h3>
 用C实现该方法，在HelloWorld.c文件中，代码如下：
  <pre class="code">  #include&nbsp;&#60;jni.h&#62; 
  #include&nbsp;"HelloWorld.h" 
  #include&nbsp;&#60;stdio.h&#62; 
  JNIEXPORT&nbsp;void&nbsp;JNICALL&nbsp;Java_HelloWorld_sayHello&nbsp;(JNIEnv&nbsp;*env,&nbsp;jobject&nbsp;obj)&nbsp;{ 
  &#160;&#160;&#160;&nbsp;printf("Hello,the&nbsp;World!!!"); 
  } </pre>
  
  <p >这里，方法签名为Java_HelloWorld_sayHello&nbsp;(JNIEnv&nbsp;*env,&nbsp;jobject&nbsp;obj)，添加了形参obj，否则无法通过编译。 </p>
  <p >其中，#include&nbsp;&#60;jni.h&#62;&nbsp; </p>
  <p >&#160;&nbsp;但是gcc里面默认环境可不知道jni.h是什么东西，jni.h在jdk的$JAVA_HOME/include或者$JAVA_HOME/include/linux下面，可进去查看一下。 </p>
  <h3 >(5)&nbsp;生成动态连接库 </h3>
  接下来，生成动态连接库libHelloWorld.so，执行命令： 
  
  <pre class="code">[home@administrator]#&nbsp;gcc&nbsp;-fPIC&nbsp;-I&nbsp;jdk/include&nbsp;-I&nbsp;jdk/include/linux&nbsp;-shared&nbsp;-o&nbsp;libHelloWorld.so&nbsp;HelloWorld.c </pre>
  
  <p >可以在当前目录下看到libHelloWorld.so，动态连接库文件名称以lib开头。将该文件拷贝到usr/lib目录下面，就可以测试了。 </p>
  
  <h3 >(6)进行测试的命令： </h3>
  <pre class="code">[home@administrator]#&nbsp;java&nbsp;HelloWorld </pre>
 输出如下： 
  <pre class="code">Hello,the&nbsp;World!!! </pre>
  
  <p >这只是一个非常简单的例子，主要是了解JNI在Linux下该如何用。在实际应用中，可能会非常复杂，并且要记住，一旦使用了JNI技术，系统的可移植性被破坏了。有些应用中，正是基于这种特性实现，比如限制软件的传播使用，保护开发商权益等等。 </p>
<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
