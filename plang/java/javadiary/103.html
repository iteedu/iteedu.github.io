<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end -->
<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->


<div class="lpindex"><a href="index.html">首页</a><a href="102.html"> 上一页</a><a href="104.html"> 下一页</a></div>
<h1>Java Gossip: &#25191;行&#32490;的同步化</h1>
<p>如果您的程序只是一&#20010;&#21333;&#25191;行&#32490;，&#21333;一流程的程序，那么通常您只要注意到程序&#36923;&#36753;的正确，您的程序通常就可以正确的&#25191;行您想要的功能，但&#24403;您的程序是多&#25191;行&#32490;程序，多流程同&#26102;&#25191;行&#26102;，那么您就要注意到更多的&#32454;&#33410;，例如在多&#25191;行&#32490;共享同一&#23545;象的&#25968;据&#26102;。<br />
<br />
如果一&#20010;&#23545;象所持有的&#25968;据可以被多&#25191;行&#32490;同&#26102;共享存取&#26102;，您必&#39035;考&#34385;到「&#25968;据同步」的 &#38382;&#39064;，所&#35859;&#25968;据同步指的是&#20004;份&#25968;据的整体性一致，例如&#23545;象A有 name与id&#20004;&#20010;&#23646;性，而有一份A1&#25968;据有name与id的&#25968;据要更新&#23545;象A的&#23646;性，如果A1的name与id&#35774;定&#32473;A&#23545;象完成，&#21017;&#31216;A1与A同步，如 果A1&#25968;据在更新了&#23545;象的name&#23646;性&#26102;，突然插入了一份A2&#25968;据更新了A&#23545;象的id&#23646;性，&#21017;&#26174;然的A1&#25968;据与A就不同步，A2&#25968;据与A也不同步。<br />
<br />
&#25968;据在多&#25191;行&#32490;下共享&#26102;，就容易因&#20026;同&#26102;多&#20010;&#25191;行&#32490;可能更新同一&#20010;&#23545;象的信息，而造成&#23545;象&#25968;据的不同步，因&#20026;&#25968;据的不同步而可能引&#21457;的&#38169;&#35823;通常不易察&#35273;， 而且可能是在您程序&#25191;行了几千几万次之后，才&#20250;&#21457;生&#38169;&#35823;，而&#36825;通常&#20250;&#21457;生在您的&#20135;品已&#32463;上&#32447;之后，甚至是程序已&#32463;&#25191;行了几年之后。<br />
<br />
&#36825;&#36793;&#20030;&#20010;&#31616;&#21333;的例子，考&#34385;您&#35774;&#35745;&#36825;么一&#20010;&#31867;&#21035;：</p>
<h5>PersonalInfo.java </h5>
<pre class="code">package onlyfun.caterpillar;
public class PersonalInfo {
	private String name;
	private String id;
	private int count;
	public PersonalInfo() {
		name = "nobody";
		id = "N/A";
	}
	public void setNameAndID(String name, String id) {
		this.name = name;
		this.id = id;
		if(!checkNameAndIDEqual()) {
			System.out.println(count +
			") illegal name or ID.....");
		}
		count++;
	}
	private boolean checkNameAndIDEqual() {
		return (name.charAt(0) == id.charAt(0)) ?
		true : false;
	}
}
</pre>
<p>  在&#36825;&#20010;&#31867;&#21035;中，您可以&#35774;定使用者的名&#31216;与&#32553;&#20889;id，并&#31616;&#21333;&#26816;查一下名&#31216;与id的第一&#20010;字是否相同，&#21333;就&#36825;&#20010;&#31867;&#21035;本身而言，它并&#27809;有任何的&#38169;&#35823;，但如果它被 用于多&#25191;行&#32490;的程序中，而且同一&#20010;&#23545;象被多&#20010;&#25191;行存取&#26102;，就&#20250;&quot;有可能&quot;&#21457;生&#38169;&#35823;，&#26469;&#20889;&#20010;&#31616;&#21333;的&#27979;&#35797;程序： </p>
<h5>SynchronizedDemo.java </h5>
<pre class="code">package onlyfun.caterpillar;
public class SynchronizedDemo {
	public static void main(String[] args) {
		final PersonalInfo person = new PersonalInfo();
		Thread thread1 = new Thread(new Runnable() {
			public void run() {
				while(true)
				person.setNameAndID("Justin Lin", "J.L");
			}
		});
		Thread thread2 = new Thread(new Runnable() {
			public void run() {
				while(true)
				person.setNameAndID("Shang Hwang", "S.H");?
			}
		});
		System.out.println("Start testing.....");
		thread1.start();
		thread2.start();
	}
}
</pre>
<p>&#26469;看一下&#25191;行&#26102;的一&#20010;例子： </p>
<pre class="code">Start testing..... 
822949) illegal name or ID..... 
1443074) illegal name or ID..... 
1750512) illegal name or ID..... 
2587632) illegal name or ID..... 
2805877) illegal name or ID..... 
3705555) illegal name or ID..... 
4000077) illegal name or ID.....?</pre>
<p> 看到了&#21527;？如果以&#21333;&#25191;行&#32490;的&#35266;&#28857;&#26469;看，上面的&#35759;息在&#27979;&#35797;中根本不可能出&#29616;，然而在&#36825;&#20010;程序中&#21364;出&#29616;了&#38169;&#35823;，而且重&#28857;是，第一次&#38169;&#35823;是&#21457;生在第822949 次的&#35774;定（您的&#35745;算机上可能是不同的&#25968;字），如果您在程序完成并&#24320;始&#24212;用之后，&#36825;&#20010;&#26102;&#38388;&#28857;可能是几&#20010;月甚至几年之后。<br />
<br />
&#38382;&#39064;出&#29616;哪？在于&#36825;&#36793;：</p>
<pre class="code">public void setNameAndID(String name, String id) {
	this.name = name;
	this.id = id;
	if(!checkNameAndIDEqual()) {
		System.out.println(count +
		") illegal name or ID.....");
	}
	count++;
}</pre>
<p>&#34429;然您&#35774;定&#32473;它的&#21442;&#25968;并&#27809;有&#38382;&#39064;，在某&#20010;&#26102;&#38388;&#28857;&#26102;，thread1&#35774;定了&quot;Justin Lin&quot;, &quot;J.L&quot;&#32473;name与id，在&#36827;行&#27979;&#35797;的前一刻，thread2可能此&#26102;&#21018;好呼叫setNameAndID(&quot;Shang Hwang&quot;,
  &quot;S.H&quot;)，在name被&#35774;定&#20026;&quot;Shang Hwang&quot;&#26102;，checkNameAndIDEqual()&#24320;始&#25191;行，此&#26102;name等于&quot;Shang Hwang&quot;，而id&#36824;是&quot;J.L&quot;，所以checkNameAndIDEqual()就&#20250;&#20256;回false，&#32467;果就&#26174;示了&#38169;&#35823;&#35759;息。<br />
  <br />
  您必&#39035;同步&#25968;据&#23545;&#23545;象的更新，也就是在有一&#20010;&#25191;行&#32490;正在&#35774;定person&#23545;象的&#25968;据&#26102;，不可以又被另一&#20010;&#25191;行&#32490;同&#26102;&#36827;行&#35774;定，您可以使用&quot;synchronized&quot;&#20851;&#38190;&#35789;&#26469;&#36827;行&#36825;&#20010;&#21160;作。<br />
  <br />
  &quot;synchronized&quot;的一&#20010;使用方式是用于方法上，&#35753;方法作用范&#22260;&#20869;都成&#20026;被同步化&#21306;域，例如：</p>
<pre class="code">public synchronized void setNameAndID(String name,String id) {
	this.name = name;
	this.id = id;
	if(!checkNameAndIDEqual()) {
		System.out.println(count +
		") illegal name or ID.....");
	}
	count++;
}</pre>
<p> 每&#20010;&#23545;象&#20869;部都&#20250;有一&#20010;&#38145;定（lock），&#24403;&#25191;行&#32490;&#25191;行某&#20010;&#23545;象的同步化方法&#26102;，它&#20250;在&#23545;象上得到&#36825;&#20010;&#38145;定，只有取得&#38145;定的&#25191;行&#32490;才可&#36827;入同步&#21306;，未取得&#38145;定的&#25191;行&#32490;&#21017;必&#39035;等待，直到有机&#20250;取得&#38145;定，其它&#25191;行&#32490;必&#39035;等目前&#25191;行&#32490;先&#25191;行完同步化方法，并解除&#23545;&#23545;象的&#38145;定，才有机&#20250;取得&#23545;象上的&#38145;定。<br />
<br />
就&#36825;&#20010;例子&#26469;&#35828;，&#31616;&#21333;的&#35828;，就是有&#25191;行&#32490;在&#25191;行setNameAndID()&#26102;，&#20250;&#20174;&#23545;象上取得&#38145;定，其它&#25191;行&#32490;必&#39035;等待它&#25191;行完&#27605;，&#37322;放&#38145;定之后，才&#20250;有机&#20250;&#31454;&#20105;&#38145;定，取得&#38145;定的&#25191;行&#32490;才可以&#25191;行setNameAndID ()。<br />
<br />
以上所介&#32461;的是&#23454;例方法同步化（instance method synchronized），同步化的&#35774;定不只可用于方法上，也可以用于某&#20010;程序&#21306;&#22359;上，&#31216;之&#20026;&#23454;例&#21306;&#22359;同步化（instance block synchronized），例如：</p>
<pre class="code">public void setNameAndID(String name, String id) {
	synchronized(this) {
		this.name = name;
		this.id = id;
		if(!checkNameAndIDEqual()) {
			System.out.println(count +
			") illegal name or ID.....");
		}
		count++;
	}
}</pre>
<p> 上面的意思就是在&#25191;行&#32490;&#25191;行至&quot;synchronized&quot;&#35774;定的&#21306;&#22359;&#26102;取得&#23545;象的&#38145;定，&#36825;么一&#26469;其它&#25191;行&#32490;&#26242;&#26102;&#26080;法取得&#38145;定，因此&#26080;法&#25191;行&#23545;象同步化&#21306;&#22359;，&#36825;&#20010;方式可以&#24212; 用于您不想&#38145;定整&#20010;方法&#21306;&#22359;，而只是想在共享&#25968;据在被&#25191;行&#32490;存取&#26102;确保同步化&#26102;，由于只&#38145;定方法中的某&#20010;&#21306;&#22359;，在&#25191;行完&#21306;&#22359;后即&#37322;放&#23545;&#23545;象的&#38145;定，以便&#35753; 其它&#25191;行&#32490;有机&#20250;取得&#38145;定，&#23545;&#23545;象&#36827;行操作，在某些&#26102;候&#20250;比&#36739;有效率。<br />
<br />
&#23454;例&#21306;&#22359;同步化的好&#22788;是，您也可以&#23545;某&#20010;&#23545;象&#36827;行同步化，而像&#23454;例方法同步化只&#38024;&#23545;this，例如在多&#25191;行&#32490;存取同一&#20010;ArrayList&#23545;象&#26102;，ArrayList并&#27809;有&#23454;作&#25968;据存取&#26102;的同步化，所以它使用于多&#25191; 行&#32490;&#26102;，必&#39035;注意是否必&#39035;&#23545;它&#36827;行同步化，多&#20010;&#25191;行&#32490;存取同一&#20010;ArrayList&#26102;，有可能&#21457;生&#20004;&#20010;以上的&#25191;行&#32490;&#23558;&#25968;据存入 ArrayList的同一&#20010;位置，造成&#25968;据的相互覆&#30422;，&#20026;了确保&#25968;据存入&#26102;的正确性，您可以在存取ArrayList&#23545;象&#26102;&#23545;它&#36827;行同步化，例如：</p>
<pre class="code">// arraylist参考至一个ArrayList的一个实例 
synchronized(arraylist) {
	arraylist.add(new SomeClass()); 
}</pre>
<p>除了&#38024;&#23545;&#23545;象同步之外，您&#36824;可以&#38024;&#23545;&#38745;&#24577;方法同步化（static method synchronized），例如某&#20010;static成&#21592;&#20250;被多&#25191;行&#32490;存取&#26102;，&#21017;可以如下&#35774;定：</p>
<pre class="code">public class Some {
private static int value;

public synchronized static void some() {
value++;
....
}
}</pre>
<p>&#36827;行&#38145;定&#26102;，&#20250;&#38145;定Some.class，因而static成&#21592;也受到保&#25252;。&#31867;似于&#23454;例&#21306;&#22359;同步化，您也可以在&#21306;&#22359;中&#38145;定整&#20010;&#31867;&#21035;，&#31216;之&#20026;&#31867;&#21035;字面同步化（class literals synchronized），例如：</p>
<pre class="code">...
public void doSomething() {
synchronized(Some.class) {
....
}
}
...</pre>
<p> 事&#23454;上，您也可以使用Collections的synchronizedXXX()等方法&#26469;&#20256;回一&#20010;同步化的容器&#23545;象，例如&#20256;回一&#20010;同步化的List：</p>
<pre class="code">List list = Collections.synchronizedList(new ArrayList());</pre>
<p> 同步化所&#29306;性的自然就是在于&#25191;行&#32490;等待&#26102;的延&#36831;，所以同步化的手法不&#24212;被&#28389;用，您不用&#23558;整&#20010;&#23545;象的方法都加上&quot;synchronized&quot;，有些方法只是&#21333;&#32431;的&#20256;回某些&#25968;值，它并&#27809;有&#23545;共享&#25968;据&#36827;行修改的&#21160;作，那么它就不需要被同步化。</p>
<div class="rpindex"><a href="104.html"> 下一页</a><a href="102.html"> 上一页</a><a href="index.html">首页</a></div>



<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
