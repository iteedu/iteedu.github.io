<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end -->
<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->



<div class="lpindex"><a href="index.html">首页</a><a href="079.html"> 上一页</a><a href="082.html"> 下一页</a></div>
<h1>用汇编编写屏幕保护程序</h1>
<p>屏幕保护程序是什么，相信大家都用过，但对于它的结构也许就不那么熟悉了。屏幕保护程序是一种特使的 .exe 文件，实际上它是一个标准的 PE 文件，除了有扩展名 
  .scr，当然这个扩展名也是用连接程序产生的 .exe 文件改名得到的。但在编程中，屏幕保护程序又有它的特殊的地方，说穿了就是它的编程规范。</p>
<p>屏幕保护程序有以下特点：</p>
<ol>
  <li>屏幕保护程序是Win32 API 支持一种特殊的应用程序并由系统自动激活。其机制是当条件满足时，系统向当前活动窗口发出字参数 wParam 值为 
    SC_SCREENSAVE 的 WM_SYSCOMMAND 消息，然后由当前活动窗口执行 SYSTEM.INI 文件中 [boot] 区指定的屏幕保护程序。</li>
  <li> 屏幕保护程序激活的条件是：在规定时间内没有鼠标或键盘输入、当前的活动窗口是标准的 WINDOWS 应用程序。因为非 WINDOWS 应用，不会理睬 
    WM_SYSCOMMAND 消息。显然，如果当前活动的程序接管了字参数 wParam 值为 SC_SCREENSAVE 的 WM_SYSCOMMAND 
    消息并且不传递到 DefWindowProc 函数就可以禁止屏幕保护程序。这对某些运行中不愿意被打断的程序如视频播放，光盘刻录程序特别有用。</li>
  <li>可以在控制面板的显示器中选择需要的屏幕保护程序，并可以配置屏幕保护程序的参数。配置的对话框由屏幕保护程序提供。</li>
</ol>
<p>下面是编写屏幕保护程序的要点：</p>
<ol>
  <li>屏幕保护程序的编写由静态链接库 SCRNSAVE.LIB 支持，它包含了建立屏幕保护程序的主程序和缺省功能，如建立一个缺省的大小为全屏幕的窗口供用户使用，并提供缺省的消息处理程序，它对下面消息的缺省处理是：<br>
    <br>
    WM_SETCURSOR -- 将光标设置为无<br>
    WM_PAINT -- 画屏幕背景<br>
    WM_LBUTTONDOWN、WM_MBUTTONDOWN、WM_RBUTTONDOWN、WM_KEYDOWN、WM_MOUSEMOVE -- 终止执行 
    <br>
    WM_ACTIVATE -- 如果 wParam 是 FALSE，则终止执行<br>
    <br>
  </li>
  <li>程序的入口代码已经包括在 scrnsave.lib 中，名称为 WinMain，所以程序尾包括 end WinMain 即可。</li>
  <li>用户只需编写三个基本函数必须名为 ScreenSaverConfigureDialog、ScreenSaverProc 和 RegisterDialogClasses，这 
    3 个函数必须在.DEF 文件中指定 export<br>
    <br>
    ScreenSaverProc - 主过程，也就是自动建立的主窗口的窗口过程，所有对屏幕的处理就是由它完成的。可以把未处理的消息传递到 DefScreenSaverProc函数，由系统处理上面说到的缺省处理。缺省 
    DefScreenSaverProc 过程处理 WM_LBUTTONDOWN、WM_MBUTTONDOWN ; WM_RBUTTONDOWN、WM_KEYDOWN、WM_MOUSEMOVE 
    消息并结束程序，如果在这些消息时不想退出，可以自行处理，不要传递到 DefScreenSaverProc。<br>
    <br>
    ScreenSaverConfigureDialog - 处理屏幕保护程序配置对话框过程，这个过程并不是由主程序调用的，而是由控制面板的显示器设置程序调用。用户输入的配置数据应该输出到.INI 
    或注册表中。<br>
    <br>
    RegisterDialogClasses - 登记屏幕保护程序配置对话框的窗口类，如果使用标准的对话框，可以简单地返回 TRUE。<br>
    <br>
  </li>
  <li>在 ScreenSaverProc 窗口过程中，有个专用消息 WM_ERASEBKGND -- 可以在这时擦除背景，如果把这个消息传到 DefScreenSaverProc，会得到一个全黑的背景。<br>
  </li>
  <li>使用时必须将编译完成的 .exe 文件改名为 .scr 文件，然后拷贝到 Windows 或 Windows\System 目录下。 </li>
  <li>为使控制面板能够识别，屏幕保护程序的图标（ICON）在资源文件中必须定义为 100，资源文件中必须包含一描述字符串。该字符串用于控制面板显示屏幕保护程序的名字。它必须位于字符串表的首位，ID 
    为 100。资源文件中屏幕保护程序配置对话框的 ID 必须为2003。 </li>
</ol>
<p>综上所述，屏幕保护程序的两个部分即窗口过程和设置对话框过程是在不同的地方被执行的，所以在编程中要注意不要在两个过程中传递变量，这就意味着屏幕保护程序的设置要被输出到 
  .ini 或注册表中保存，在窗口过程中的 WM_CREATE 消息中再读入，因为你无法把它保留在内存中。同样窗口过程和设置对话框过程中的变量或资源的初始化也要分别进行，比如说两者都要用到同一个图片，那就在自己的 
  WM_CREATE 消息中分别 LoadBitmap，总之要时刻认为你是在编写两个“独立的程序”。</p>
<p>下面是一个屏幕保护程序的资源定义例子：</p>
<pre class="code">#include	<resource.h>

#define	ICO_MAIN		100
#define	DLG_SETUP		2003

ICO_MAIN	ICON		"Resource\Main.ico"

DLG_SETUP	DIALOG DISCARDABLE  0, 0, 300, 120
STYLE		DS_MODALFRAME | WS_POPUP | WS_CAPTION | WS_SYSMENU
CAPTION		"屏幕保护程序"
FONT		9, "宋体"
BEGIN
    ...
    ...
           DEFPUSHBUTTON  "确定(&O)",       IDOK,		240,10,50,14
  PUSHBUTTON  "取消(&C)",       IDCANCEL,	240,29,50,14
              END

STRINGTABLE	DISCARDABLE
BEGIN
	100	"保护程序"
              END
.def 文件例子：

EXPORTS
ScreenSaverProc
ScreenSaverConfigureDialog
RegisterDialogClasses

源代码例子：

;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
;	Programmed by 罗云彬, bigluo@telekbird.com.cn
;	Website: http://asm.yeah.net
;	LuoYunBin's Win32 ASM page (罗云彬的编程乐园)
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
;	版本信息
;	屏幕保护程序模板
;	Ver 1.0 - 2000.07.15
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

.386
.MODEL        FLAT, STDCALL
		option casemap :none   ; case sensitive

;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
;	Include 数据
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
     INCLUDE  WINDOWS.INC
     INCLUDE  USER32.INC
     INCLUDE  KERNEL32.INC
     INCLUDE  COMCTL32.INC
     INCLUDE  COMDLG32.INC
     INCLUDE  GDI32.INC
     INCLUDE  ADVAPI32.INC
     INCLUDE  SHELL32.INC
     INCLUDE  SCRNSAVE.INC

  INCLUDELIB  USER32.LIB
  INCLUDELIB  KERNEL32.LIB
  INCLUDELIB  COMCTL32.LIB
  INCLUDELIB  COMDLG32.LIB
  INCLUDELIB  GDI32.LIB
  INCLUDELIB  ADVAPI32.LIB
  INCLUDELIB  SHELL32.LIB
  INCLUDELIB  SCRNSAVE.LIB
  INCLUDELIB  MSVCRT.LIB
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
;	Equ 数据
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    ICO_MAIN  EQU       100         ;Must be 100
   DLG_SETUP  EQU       2003        ;Must be 2003

;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
;	数据段
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

.DATA?

   HINSTANCE  DD        ?
    HWINMAIN  DD        ?

;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
;	代码段
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

.CODE

;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
; 设置对话框过程
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          SCREENSAVERCONFIGUREDIALOG  PROC      USES EBX EDI ESI, \
		hWnd:DWORD,wMsg:DWORD,wParam:DWORD,lParam:DWORD

              MOV       EAX,WMSG
;********************************************************************
.ELSEIF       EAX == WM_CLOSE
              INVOKE    ENDDIALOG,HWND,NULL
;********************************************************************
.ELSEIF       EAX == WM_COMMAND
              MOV       EAX,WPARAM
.IF           EAX ==	IDOK
                ...                在此保存设置                ...
              INVOKE    ENDDIALOG,HWND,NULL
.ELSEIF       EAX ==	IDCANCEL
              INVOKE    ENDDIALOG,HWND,NULL
.ENDIF
.ELSE
              MOV       EAX,FALSE
              RET
.ENDIF
              MOV       EAX,TRUE
              RET
		
          SCREENSAVERCONFIGUREDIALOG  ENDP

;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
; 主程序窗口过程
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
         SCREENSAVERPROC  PROC      USES EBX EDI ESI, \
		hWnd:DWORD,uMsg:DWORD,wParam:DWORD,lParam:DWORD

              MOV       EAX,UMSG
.IF           EAX ==	WM_CREATE
              INVOKE    GETMODULEHANDLE,NULL
              MOV       HINSTANCE,EAX
              MOV       EAX,HWND
              MOV       HWINMAIN,EAX            ...
            在此初始化，包括定义一个定时器            ...
              INVOKE    SETTIMER,HWINMAIN,TIMER_MOON,100,NULL
.ELSEIF       EAX ==	WM_DESTROY
              CALL      _QUIT
;********************************************************************
.ELSEIF       EAX ==	WM_TIMER
            ...
            在此画屏幕动画            ...
              XOR       EAX,EAX
              RET
;********************************************************************
;		.elseif	eax ==	WM_ERASEBKGND
;********************************************************************
; 以下黑屏的代码在 DefScreenSaverProc 中已经包括，如果自己要处理
; 屏幕，可以把它去掉。
;********************************************************************
;			invoke	GetDC,hWnd
;			mov	@hDc,eax
;			invoke	GetClientRect,hWnd,addr @stRc
;			invoke	GetStockObject,BLACK_BRUSH
;			invoke	FillRect,@hDc,addr @stRc,eax
;			invoke	ReleaseDC,hWnd,@hDc
;			xor	eax,eax
;			ret
.ENDIF
;********************************************************************
              INVOKE    DEFSCREENSAVERPROC,HWND,UMSG,WPARAM,LPARAM
              RET

         SCREENSAVERPROC  ENDP

;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
; 注册设置对话框窗口Class过程
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
   REGISTERDIALOGCLASSES  PROC      USES EBX EDI ESI, HINST:DWORD

              MOV       EAX,TRUE
              RET

   REGISTERDIALOGCLASSES  ENDP
;>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
              END       WINMAIN
</pre>
以上是一个屏幕保护程序的框架结构，其实编写一个屏幕保护程序的大部分工作量在于 WM_TIMER 消息的处理，也就是说对动画的处理，如果就把上面的程序编译，那么你就会得到一个最简单的“黑屏”屏保。
<div class="rpindex"><a href="082.html"> 下一页</a><a href="079.html"> 上一页</a><a href="index.html">首页</a></div>



<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
