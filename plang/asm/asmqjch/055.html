<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end -->
<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->



<div class="lpindex"><a href="index.html">首页</a><a href="054.html"> 上一页</a><a href="056.html"> 下一页</a></div>
<h1>客户寄存器结构</h1>
<p>我们将学习本教程中另外一个重要的结构，叫客户寄存器结构。在本文中，V86指虚拟8086模式。</p>
<p>理论</p>
<p>VxDs与正常的win32/win16/DOS应用程序有很大不同。大多数情况下，当其他应用程序正常工作时，它们是休眠的。它们象一个监管者一样工作，其作用是监视ring-3应用程序并在其出错时改正它们。下面是其工作时的典型的情况：</p>
<p> 1、中断发生时<br>
  2、VMM得到控制权时 <br>
  3、VMM存贮寄存器组的值时 <br>
  4、VMM服务于中断或调用其他VxDs完成此工作时 <br>
  5、VMM交还控制权给被中断的程序时 </p>
<p>在以上过程中令人感兴趣的是，VMM只有这一种方式能影响被中断的应用程序，即修改存储的寄存器映象。例如，VMM认为被中断的程序应该返回到另外一个地址，它就修改存储的寄存器映象中CS：IP的值，当这个程序被重新分派时，它将在新的CS：IP处开始执行。</p>
<p>VMM在客户寄存器结构中存储中断点处的寄存器值。</p>
<pre class="code"> Client_Reg_Struc STRUC<br>
  Client_EDI DD ? <br>
  Client_ESI DD ?<br>
  Client_EBP DD ?<br>
  Client_res0 DD ?<br>
  Client_EBX DD ?<br>
  Client_EDX DD ?<br>
  Client_ECX DD ?<br>
  Client_EAX DD ?<br>
  Client_Error DD ?<br>
  Client_EIP DD ?<br>
  Client_CS DW ?<br>
  Client_res1 DW ?<br>
  Client_EFlags DD ?<br>
  Client_ESP DD ?<br>
  Client_SS DW ?<br>
  Client_res2 DW ?<br>
  Client_ES DW ?<br>
  Client_res3 DW ?<br>
  Client_DS DW ?<br>
  Client_res4 DW ?<br>
  Client_FS DW ?<br>
  Client_res5 DW ?<br>
  Client_GS DW ?<br>
  Client_res6 DW ?<br>
  Client_Alt_EIP DD ?<br>
  Client_Alt_CS DW ?<br>
  Client_res7 DW ?<br>
  Client_Alt_EFlags DD ?<br>
  Client_Alt_ESP DD ?<br>
  Client_Alt_SS DW ?<br>
  Client_res8 DW ?<br>
  Client_Alt_ES DW ?<br>
  Client_res9 DW ?<br>
  Client_Alt_DS DW ?<br>
  Client_res10 DW ?<br>
  Client_Alt_FS DW ?<br>
  Client_res11 DW ?<br>
  Client_Alt_GS DW ?<br>
  Client_res12 DW ?<br>
  Client_Reg_Struc ENDS </pre>
<p> 你可以看到这个结构分为两个部分：Client_xxx和Client_Alt_xxx。在这稍作说明，在一个给定的VM中，可能有两个运行的线程：V86和保护模式。当V86程序运行时，假如一个中断产生，Client_xxx将包含V86程序的寄存器映象，Client_Alt_xxx将包含保护模式程序的寄存器映象。相应的，当保护模式程序运行时，假如一个中断产生，Client_xxx将包含保护模式程序的寄存器映象，Client_Alt_xxx将包含V86程序的寄存器映象。Client_resX被保留而没有使用。</p>
<p> 在查看过这个结构后，你可能有一问题：怎样改变寄存器中的一个字节，比如al？上面的结构仅仅描述了字和双字大小的寄存器组。不用担心，在vmm.inc找一找。那有两个为此附加的结构：Client_Word_Reg_Struc和Client_Byte_Reg_Struc。假如你想以字或字节大小来访问寄存器，根据你的需要转换Client_Reg_Struc到Client_Word_Reg_Struc或Client_Byte_Reg_Struc。</p>
<p> 下一个问题：我们如何得到一个指向客户寄存器结构的指针？</p>
<p> 这相当简单：一般地，当VMM调用我们的VxD时，把客户寄存器结构的地址放在ebp中。在这里的客户寄存器结构是当前VM的。你可以从VM的句柄中得到这个指针。记住，VM的句柄是VM控制块的线性地址。</p>
<pre class="code"> cb_s STRUC<br>
  <br>
            CB_VM_Status  DD        ?<br>
          CB_High_Linear  DD        ? <br>
       CB_Client_Pointer  DD        ? <br>
     CB_VMID  DD        ? <br>
            CB_Signature  DD        ?<br>
  <br>
  cb_s ENDS<br>
  CB </pre>
<p> CB_Client_Pointer包含指向VM的客户寄存器结构的指针。例如：你可用下边的代码得到指向当前VM中的客户寄存器结构的指针：</p>
<pre class="code"> VMMCall Get_Cur_VM_Handle ; return the current VM handle 
  in ebx<br>
  assume ebx:ptr cb_s <br>
  mov ebp,[ebx+CB_Client_Pointer] ; pointer to client reg struct </pre>
<p> 现在我们了解了客户寄存器结构，我们可以用它来开始工作了。我们将使用客户寄存器结构去传送寄存器组的值到一个DOS中断中，也就是，int 21h,功能2h,显示一个字符。这个DOS服务把要显示的字符放在dl中。假如我们传送响铃字符（07h)到这个服务，将通过PC喇叭发出一声响。 
</p>
<p> 记住，int 21h是一个DOS服务，因而其在V86模式下是可用的，我们如何在VxD中调用一个V86中断？一个方法是使用Exec_Int服务。这个VMM服务把要调用的中断号放在eax中。它模拟指定的中断然后返回到调用的VM。然而，它必须在一个嵌套执行块中被调用。嵌套执行块被Begin_Nest_V86_Exec 
  (或 Begin_Nest_Exec)和End_Nest_Exec包括起来。如果我们要调用int 21h功能2h，我们需要在嵌套执行块内转换Client_Byte_Reg_Struc结构的Client_ah和Client_Dl，然后把值21h放在eax中。当一切准备好了，就调用Exec_Int。</p>
<p>例子：</p>
<p>例子是一个动态VxD，它调用int 21h的功能2使PC喇叭发声。</p>
<pre class="code">.386p 
include \masm\include\vmm.inc 
include \masm\include\vwin32.inc 
include \masm\include\v86mmgr.inc 
VxDName TEXTEQU <VXDINT> 
ControlName TEXTEQU <VXDINT_Control> 
VxDMajorVersion TEXTEQU <1> 
VxDMinorVersion TEXTEQU <0> 

VxD_STATIC_DATA_SEG 
VxD_STATIC_DATA_ENDS 

VXD_LOCKED_CODE_SEG 
;---------------------------------------------------------------------------- 
; Remember: The name of the vxd MUST be uppercase else it won't work/unload 
;---------------------------------------------------------------------------- 
DECLARE_VIRTUAL_DEVICE %VxDName,%VxDMajorVersion,%VxDMinorVersion, %ControlName,UNDEFINED_DEVICE_ID,UNDEFINED_INIT_ORDER 

Begin_control_dispatch %VxDName 
        Control_Dispatch W32_DEVICEIOCONTROL, OnDeviceIoControl 
End_control_dispatch %VxDName 

VXD_LOCKED_CODE_ENDS 

VXD_PAGEABLE_CODE_SEG 
BeginProc OnDeviceIoControl 
 assume esi:ptr DIOCParams 
 .if [esi].dwIoControlCode==1 
  Push_Client_State 
  VMMCall Begin_Nest_V86_Exec 
  assume ebp:ptr Client_Byte_Reg_Struc 
  mov [ebp].Client_dl,7 
  mov [ebp].Client_ah,2 
  mov eax,21h 
  VMMCall Exec_Int 
  VMMCall End_Nest_Exec 
  Pop_Client_State 
EndI: 
 .endif 
 xor eax,eax 
 ret 
EndProc OnDeviceIoControl 
VXD_PAGEABLE_CODE_ENDS 

end
</pre>
<p>讲解 </p>
<p>Push_Client_State</p>
<p> 这没什么好讲解的。当一个VxD接收到一个DeviceIoControl消息，ebp已经指向了当前VM的客户寄存器结构。我们调用Push_Client_State宏在堆栈中存储客户寄存器结构的状态。然后用Pop_Client_State宏恢复客户寄存器。 
</p>
<p>VMMCall Begin_Nest_V86_Exec </p>
<p>通过调用Begin_Nest_V86_Exec开始嵌套执行块。</p>
<pre class="code"> assume ebp:ptr Client_Byte_Reg_Struc<br>
  mov [ebp].Client_dl,7 <br>
  mov [ebp].Client_ah,2 </pre>
<p>改变在客户寄存器中的dl和ah寄存器的映象。这个改变的值将由中断使用。 </p>
<pre class="code">mov eax,21h <br>
  VMMCall Exec_Int </pre>
<p>Exec_Int要求在eax存有一个中断号。我们想使用int 21h。等会我们调用Exec_Int去模拟中断。 </p>
<pre class="code">VMMCall End_Nest_Exec<br>
  Pop_Client_State</pre>
<p> 当Exec_Int返回，我们完成了嵌套执行块，并且由堆栈中恢复了客户寄存器结构的值。 你将听到你的PC喇叭发出一声响。 </p>
<div class="rpindex"><a href="056.html"> 下一页</a><a href="054.html"> 上一页</a><a href="index.html">首页</a></div>



<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
