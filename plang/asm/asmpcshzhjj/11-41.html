<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end -->
<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->


  <div class="lpindex"><a href="index.html">目录</a> <a href="11-4.html">上一页</a> <a href="appendexa.html">附录A</a>  </div>
  <p>&quot;SEGMENT&quot;伪指令的标准用法应该如下所示：<br />
  段名 SEGMENT 定位类型 组合类型   类别名称</p>
  <h5>（1）定位类型</h5>
  <p>有些参考书称定位类型指得是段的起始位置，实际上定位类型可以理解为    &quot;对两个相临段的段地址给予的一些规定&quot;。定位类型可以有以下几种：</p>
  <p> PARA：指定所定义的段开始于小段边界，实际是规定这个段的起始地址与前面一个段的起始地址之差必须是16字节的整数倍。这意味着相临两个段的段地址之差最小也得是1。给出的示例程序就是采用了PARA定位类型。<br />
    PAGE：指定定义的段开始于页边界，实际是规定这个段的起始地址与前面一个段的起始地址之差必须是256字节的整数倍。 <br />
    BYTE：所定义的段开始于字节边界，实际上是指这个段可以从任何地址开始。 <br />
    WORD：所定义的段开始于字边界，实际是指这个段只能从偶数地址开始。</p>
  <p>如果源程序中指定了段的定位类型为PARA或PAGE，那么获得的可执行文件中相临段的段地址就有差异。但是如果源程序中指定了段的定位类型是BYTE或WORD，那么在可执行文件中相临段的段地址就有可能相同。为了说明这个问题，我们下面给出了一个程序例： </p>
  <h5>DEMO.ASM</h5>
  <pre class="code">        data  segment   para public 'data'
              assume    ds:data
         msg  db        'DEMO',0dh,0ah,24h
        data  ends
		
        code  segment   para public 'code'
              assume    cs:code
        main  proc      far
              push      ds
              xor       ax,ax
              push      ax
              mov       ax,data
              mov       ds,ax
              mov       dx,offset msg
              mov       ah,9
              int       21h
              ret
        main  endp
        code  ends
              end       main
  </pre>
  <p>这个程序编译之后数据段地址为0F9CH，代码段地址为0F9DH，两者相差1。这恰好说明了数据段首与代码段首相差了16个字节。</p>
  <pre class="code">C:\ASM\&gt;debug   demo.exe[Enter]
-u0 10[Enter] 
0F9D:0000		1E			PUSH	DS
0F9D:0001		33C0		XOR		AX,AX
0F9D:0003		50			PUSH	AX
0F9D:0004		B89C0F		MOV		AX,0F9C
0F9D:0007		8ED8		MOV		DS,AX
0F9D:0009		BA0000		MOV		DX,0000
0F9D:000C		B409		MOV		AH,09
0F9D:000E		CD21		INT		21
0F9D:0010 		CB 			RETF 		
  </pre>
  <p>如果把数据段与代码段的定位类型改成&quot;BYTE&quot;，那么编译之后的程序就是下面这样了：</p>
  <pre class="code">C:\ASM\&gt;debug   demo.exe[Enter]
-u7 17[Enter] 
0F9C:0007		1E			PUSH	DS
0F9C:0008		33C0		XOR		AX,AX
0F9C:000A		50			PUSH	AX
0F9C:000B		B89C0F		MOV		AX,0F9C
0F9C:000E		8ED8		MOV		DS,AX
0F9C:0010		BA0000		MOV		DX,0000
0F9C:0013		B409		MOV		AH,09
0F9C:0015		CD21		INT		21
0F9C:0017 		CB 			RETF 		
  </pre>
  <p>可以看到代码与数据都在0F9CH段里了。这种情况有些象COM文件，不过这个程序不能转换成COM文件，因为代码的起始地址不是偏移0100H。</p>
  <p> 那么将源程序中的&quot;PARA&quot;改成&quot;BYTE&quot;后程序的起始地址为什么是0007H呢？这只要算清数据段内究竟有几个字节数据就可以搞清楚了。</p>
  <p> 这样一来就可以推断出如果再把&quot;BYTE&quot;改成&quot;WORD&quot;，那么代码的偏移地址就应该是0008H，大家可以自行修改源程序进行验证。</p>
  <h5> （2）组合类型</h5>
  <p> 组合类型与模块化程序设计技术有关。前面已经说过，每个模块都是一个独立的源程序，都有自己的段定义。设置一定的组合类型就可以通知LINK程序把一些分散在不同模块内的同类型段组织在一个段内，这样可以使最终形成的可执行文件结构比较清晰。组合类型共有5种：</p>
  <p> PUBLIC：   凡是组合类型为PUBLIC的同名段在连接时都会被组织到一起，段的顺序按OBJ文件的先后顺序安排。<br />
    COMMON：   这种类型的段在连接时会被其它模块中的同名段覆盖掉，连接后段的长度以所有同名段中最长者为准。通常情况下这种类型的段可应用于在不同的模块之间共享数据，对于定义一般的数据定义而言不使用这种类型的段。<br />
    AT   表达式：编译程序把表达式的值当作该段的段地址，采用这种组合类型可以很方便地从内存中取得数据。比如采用下面定义的这个段就可以很方便地从BIOS数据区内取得系统时钟计数： </p>
  <pre class="code">    BIOSDATA  SEGMENT   AT 0040H
              ORG       6CH
       TIMER  DD        ?
    BIOSDATA  ENDS
        CODE  SEGMENT
              ASSUME    CS:CODE
      START:  MOV       AX,BIOSDATA
              MOV       ES,AX
              MOV       DX,WORD PTR ES:TIMER
				......
  </pre>
  <p>STACK：   指定该段运行时作为堆栈段的一部分。<br />
    MEMORY：指定该段在所有连接在一起的段的前面（高地址方向为&quot;前&quot;）。如果连接时遇到多个MEMORY段，则第一个作为MEMORY段，后面的都作为COMMON段。</p>
  <p> 至于段的类别指得是连接时用于组成段组的名字。在前面给出的TEST程序例中，两个模块的数据段的组合类型均为&quot;PUBLIC&quot;，段名均为&quot;DATA&quot;，类别都是&quot;DATSEG&quot;，这样的两个段在连接时会被LINK程序组织在一起共同一个段地址，各个数据的偏移地址都会自动处理好。这样只需在主模块TEST1中设置DS寄存器即可，在TEST2中无需再设置DS。</p>
  <p> 但是如果这两个数据段段名不同或类别不同，那么这两个段虽然也会被组织在一起，但是两个段不能使用同一个段地址，这样一来就不得不在两个模块中各自设置自己的DS段寄存器。</p>
  <p>&quot;SEGMENT&quot;伪指令在模块化程序设计技术中的应用重点主要是&quot;组合类型&quot;这部分内容，模块化程序设计的另一个重点就是不同的模块之间如何相互调用以及如何共享数据。这部分内容主要应用的伪指令有两个：EXTRN和PUBLIC。</p>
  <p> ·EXTRN </p>
  <p> 当一个模块需要调用其它模块中的子程序或者需要使用其它模块中的数据，那么首先要使用这个伪指令说明调用的子程序或引用的数据是&quot;外部的（External）&quot;。这个伪指令的用法很简单，如果用于说明所调用的子过程，就应该写成：</p>
  <p> EXTRN   过程名：属性<br />
    这里的属性是指&quot;近程&quot;（NEAR）或&quot;远程&quot;（FAR）。<br />
    如果用于说明所引用的数据，则应写成：<br />
    EXTRN   数据标号：类型<br />
    类型指得是&quot;BYTE&quot;（字节）或&quot;WORD&quot;（字）。</p>
  <p> 在给出的示例程序中，TEST1模块要调用TEST2模块中的&quot;HEX2ASC&quot;子过程，因此在TEST1中就有一行&quot;EXTRN   HEX2ASC：FAR&quot;，这一行说明了&quot;HEX2ASC&quot;子过程是在其它模块中，这样编译程序就不会因为在TEST1中找不到&quot;HEX2ASC&quot;子过程而显示出错信息了。</p>
  <p> ·PUBLIC</p>
  <p> 并非一个模块中所有的数据与子过程都可以由其它模块调用或引用，如果某个模块中的数据或子过程确实允许其它模块使用，那么这样的数据与子过程应该使用&quot;PUBLIC&quot;伪指令进行说明，格式为：</p>
  <p> PUBLIC   过程名（或数据标号）</p>
  <p> 这里的&quot;PUBLIC&quot;伪指令与组合类型中的&quot;PUBLIC&quot;不是一回事，大家不可以将其混为一谈。</p>
  <p> 应用&quot;EXTRN&quot;与&quot;PUBLIC&quot;伪指令就可以方便的使不同的模块共享数据与子过程，不过这还不是唯一的方法。对于&quot;共享数据&quot;这个问题而言还有另一种方法就是使用组合类型为&quot;COMMON&quot;的段。请看下面给出的例子： </p>
  <pre  class="code">module1.		asm						
        data  segment   para COMMON 'data'
              assume    ds:data
        num1  dw        ?
        num2  dw        ?
        data  ends
		......	


module2.		asm						
        data  segment   para COMMON 'data'
              assume    ds:data
        num1  dw        2
        num2  dw        5
        data  ends
		......								

</pre>
  <p>由于两个模块中的DATA段都是&quot;COMMON&quot;类型的，所以这两个模块在连接的时候模块1中的DATA段会被模块2中的DATA段&quot;覆盖&quot;。因此虽然模块1的数据段中有两个字的数据，模块2的数据段内也有两个字，但是最终生成的可执行文件中只有一个数据段且其中只有两个字，而不是有四个字。</p>
  <p> 正是由于&quot;覆盖&quot;的关系，所以模块1中的num1与模块2中的num1实际是在内存同一地址处，所以在模块1中引用num1就等于引用了模块2中的num1。这样就形成了数据共享的关系。</p>
  <p> 以上介绍的是模块化程序设计技术中最基本的内容，实际上模块化程序设计技术中还有两个重点内容：第一是汇编子程序库的建立与维护；第二是汇编语言与高级语言的联合编程。限于篇幅，有关这两方面的内容本书不再介绍。</p>
  <h4> 本章结束语</h4>
  <p> 本章对于程序设计技术所进行的讨论是很简单的，并不十分全面。有些重要的内容，如TSR程序的设计技巧我们没有进行更多的研究，实际上单单是TSR程序的设计技巧就足以写一本书来讲述。笔者在这最后一章内只是很初步地给大家开了个头儿，更深入的内容还要读者自己去探索。想学会一种本领不容易，想学精一种本领就更难了，探索是永无止境的。</p>
  <div  class="rpindex"><a href="appendexa.html">附录A</a><a href="11-4.html">上一页</a> <a href="index.html">目录</a> </div>


<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
