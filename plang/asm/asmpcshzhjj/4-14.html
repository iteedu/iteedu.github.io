<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end -->
<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->


  <div  class="lpindex"><a href="index.html">目录</a> <a href="4-13.html">上一页</a> <a href="4-15.html">下一页</a> </div>
  <p>有时候程序中可能有逻辑错误，这需要我们用DEBUG将其排除掉，将一个可执行文件调入DEBUG中的方法在前面已经应用过： </p>
  <pre class="code">C:\ASM\&gt;DEBUG PROG7.COM[Enter] </pre>
  <p>或者这样操作:</p>
  <p>L（LOAD）命令的作用是装入一
    个文件，文件名由N命令给出。</p>
  <pre class="code">C:\ASM\>DEBUG[Enter]
-NPROG7.COM[Enter]
-L[Enter]</pre>
  <p>文件装入后即可用T、P命令跟踪执行或用U命令反汇编，下面是PROG7的反汇编形式：</p>
  <pre  class="code">-U[Enter]
0A3E:0100		B0B6		MOV		AL,B6
0A3E:0102		E643		OUT		43,AL
0A3E:0104		B8A904		MOV		AX,04A9
0A3E:0107		E642		OUT		42,AL
0A3E:0109		8AC4		MOV		AL,AH
0A3E:010B		E642		OUT		42,AL
0A3E:010D 		E461 		IN 		AL,61
0A3E:010F		50			PUSH	AX
0A3E:0110		0C03		OR		AL,03
0A3E:0112		E661		OUT		61,AL
0A3E:0114		B401		MOV		AH,01
0A3E:0116		CD21		INT		21
0A3E:0118		58			POP		AX
0A3E:0119		E661		OUT		61,AL
0A3E:011B 		C3 			RET 		

</pre>
  <p>PROG7的结构过于简单了，还没有涉及有关分段的更多概念，下面给出的这个例子更复杂一些，这个例程中具有&quot;数据&quot;和&quot;代码&quot;两个段，而且有两个&quot;过程&quot;。程序中新出现了一个陌生的指令：──SUB </p>
  <p>助记符：SUB（subtract）<br />
    用　途：将两个数据作减法<br />
    格　式：SUB 寄存器，立即数<br />
    SUB   寄存器，寄存器<br />
    SUB 寄存器，存储单元<br />
    SUB 存储单元，寄存器<br />
    SUB   存储单元，立即数<br />
    执　行：两个数据相减，结果保存在左边的寄存器或存储器中，标志寄存器中相关位被设置 </p>
  <h5>PROG7-A</h5>
  <pre class="code">PORT_B	equ	61H								；#1--常量定义
data	segment								；#2--数据段定义
	assume	ds:data							；通知编译程序默认DS寄存器指向数据段
			
			
mess	db 'Press any key to stop!!!',24h 	；定义一个字符串 	
			
data	ends								；数据段结束
			
code	segment								；#3--代码段开始
	assume	cs:code							；通知编译程序默认CS寄存器指向代码段
sound	proc	near						；#4--SOUND子过程开始
	mov	al,10110110b						；初始化定时器
	out	43h,al	
			
	mov	ax,4a9h								；设定频率
	out	42h,al	
	mov	al,ah	
	out	42h,al	
			
	in	al,PORT_B 							；打开定时器和与门
			
		al,3	
	or	PORT_B,al	
	out		
			
	ret										；子过程返回
sound	endp		
			
main	proc	far							；#5--主过程开始
	push	ds								；#6--初始化堆栈，建立返回地址
	sub	ax,ax	
	push	ax	
			
	mov	ax,data								；#7--初始化DS寄存器
	mov	ds,ax	
	mov	dx,offset mess						；#8--显示MESS
	mov	ah,09h	
	int	21h	
	 call	sound							；调用SOUND发声
	mov	ah,1	
	int	21h									；等待按键
	in	al,PORT_B	
	and	al,0fch								；停止发声
	out	PORT_B,al	
	ret										；主过程返回
main	endp								；主过程结束
code	ends								；代码段结束
	end 	main 							；进程结束 
</pre>
  <p>使用SUB指令的一些注意事项将在后面介绍。请注意这个程序中用许多前面加了&quot;#&quot;的注释文字将源程序分成了小块，这些说明性的文字可以不必录入，但如果大家在自己编制程序时能够加入必要的注释将会培养出一种很受欢迎的编程风格。</p>
  <p> 程序的&quot;#1&quot;部分作用是定义常量，所谓常量其实就是用一些具有特殊含义的字串来代替数字用在程序中。常量定义有两种方法： </p>
  <p>常量名 EQU 数字</p>
  <p>或</p>
  <p>常量名　=　数字</p>
  <p>“＝”和“EQU”伪指令的作用是一样的。注意汇编语言并不要求用户在编制每一个程序时都定义常量，但是把一些程序中经常用到的数据定义成常量还是很有好处的，因为一旦需要修改数据，则只需在常量定义部分修改即可，而不必在源程序中苦苦寻找。</p>
  <p> “#2”部分定义了一个数据段，其定义方法同4.1.2节介绍的代码段一样，也使用“SEGMENT”伪操作。需要说明的是数据段中多了一个伪指令--ASSUME，这个伪指令说明了段 与段寄存器的联系，有了这个伪指令，编译程序就知道了在程序中引用某段中的数据时应该用哪个段寄存器给出段地址。</p>
  <p> 在数据段中我们使用了&quot;DB&quot;伪指令定义的一个字符串，字符串前面的&quot;MESS&quot;是一个&quot;标号&quot;，它表示这个字符串的地址。标号可以是除汇编语言保留字外的任何字串，但不能以数字打头。标号有时也用于代码中，表示其后指令的地址，这样一来当我们用JMP、JZ等转移指令时就可以不必关心具体的目的地址了。</p>
  <p>数据段结束也使用ENDS伪指令，具体形式同代码段一样。</p>
  <p>&quot;#3&quot;部分定义了一个代码段，并用&quot;ASSUME&quot;伪指令说明了与其关联的段寄存器。</p>
  <p>这里有个很重要的问题要提醒大家，虽然在源程序中可以把数据与代码分别安排在两个段内，但这并不意味着在编译成的可执行文件里数据与代码仍然分成两个段。实际上源程序中分段的概念与内存的分段是有些区别的，因为源程序中的段定义还可以加入&quot;定位类型&quot;、&quot;组合类型&quot;之类信息，这些内容在刚刚给出的这个程序中没有体现。有关这一部分内容将在本书最后一章进行说明。</p>
  <p>&quot;#4&quot;部分是一个具有&quot;NEAR&quot;属性的过程，它是这个程序的核心，作用是使定时器发声。在这个过程中我们使用了前面定义的常量PORT＿B来代替以前用的数字61H。SOUND是这个过程的名字，它实际上也表示了这个过程的起始地址。这样在主过程中用CALL指令调用这个子过程时就不必给出具体的地址了，只需引用这个过程名就行了。这同DEBUG相比是个不小的优点。</p>
  <p>从&quot;#5&quot;部分开始就是这个程序的主过程，&quot;#6&quot;、&quot;#7&quot;部分看上去好象多余，其实不然。由于主过程具有&quot;FAR&quot;属性，因此主过程结束时的RET指令将被编译程序译成&quot;RETF&quot;远程返回指令。我们之所以事先在堆栈中设定返回地址为DS：0是为了能正确结束程序并返回DOS。那么DS：0处究竟有什么奥秘呢？用DEBUG分析一下这个程序就清楚了。 </p>
  <pre class="code">C:\ASM\&gt;DEBUG PROG7-A.EXE[Enter]
-r
AX=0000 BX=0000 CX=0052 DX=0000 SP=0000 BP=0000 SI=0000 DI=0000
DS=0A3F ES=0A3F SS=0A4F CS=0A51 IP=0102 NV UP EI PL NZ NA PO NC
0A51:0014 1E PUSH DS    注意IP寄存器的指向
</pre>
  <p>用R命令列出寄存器后就会发现DS寄存器和CS的值不一样。</p>
  <pre class="code">-uds:0 6[Enter]
0A3F:0000		CD20		INT		20
0A3F:0002		FF9F009A	CALL FAR		[BX+9A00]
0A3F:0006		F0			LOCK		
</pre>
  <p>又是&quot;INT   20&quot;。大家是不是又看到一些似曾相识的数据呢？</p>
  <p> 事实上，无论是&quot;COM&quot;还是&quot;EXE&quot;文件，DOS在调入它们时都要保留256字节来预置一些数据，我们把这256字节称为&quot;程序段前缀&quot;（PSP--Program   Segment   Prefix），对于一个&quot;COM&quot;文件，由于只有一个段，所以PSP、代码、数据和堆栈都在这个段中，PSP在头部，堆栈在尾部，中间是代码和数据，一个&quot;COM&quot;程序在调入内存执行时DOS会自动在堆栈中存入一个0，所以&quot;COM&quot;程序只需使用近程的RET指令就能返回DOS，并且无需自己初始化堆栈。</p>
  <p>&quot;EXE&quot;文件的PSP、数据和代码分在不同的段内，当一个&quot;EXE&quot;程序调入内存执行时，DOS会使DS、ES寄存器指向PSP所在段，使SS寄存器指向堆栈段而使CS寄存器指向代码段。所以&quot;EXE&quot;程序若要用&quot;RET&quot;指令结束返回系统，就必须自己在堆栈中填入返回地址，这个返回地址就是&quot;DS：0&quot;。由于这个地址是远程的，所以&quot;EXE&quot;程序的主过程要定义成&quot;FAR&quot;属性，这使得过程最后的&quot;RET&quot;指令实际被编译为&quot;RETF&quot;。</p>
  <p> 有关PSP的内容还有很多，在处理文件时我们还要使用其中很多的数据，这些知识将在第七章详细介绍。</p>
  <p>&quot;#9&quot;部分是用于显示&quot;MESS&quot;字符串的，由于09H功能要求字符串的段地址必须在DS寄存器而偏移地址要在DX寄存器中，因此程序需要取到MESS的偏移地址，前面我们谈到标号MESS表示了字符串的地址，但并未说明它究竟表示段地址还是偏移地址。实际上标号既表示段地址也表示偏移地址。我们现在想取到偏移地址，所以用了一个&quot;分析运算符&quot;--OFFSET，它表示我们要取的是偏移地址。如果我们要取段地址，我们就要使用&quot;SEG&quot;运算符，相应的程序可以写成&quot;MOV   DX，SEG   MESS&quot;。不过我们现在无需再取MESS的段地址，&quot;#7&quot;部分已经做了这件事。</p>
  <p>接下来的&quot;CALL&quot;指令调用了SOUND子过程发声。代码段结束后我们用&quot;END&quot;伪指令结束进程并指出了主过程。注意由于这个程序中的主过程并不在代码段的起始处，所以&quot;END&quot;后面必须指明主过程，否则编译程序将认为位于代码段起始处是这个程序的入口，这将导致错误。</p>
  <p>源程序录入后我们就可以将其编译、连接成可执行程序。执行TLINK时不能再加&quot;/T&quot;参数，因为这个程序不能转成&quot;COM&quot;文件。</p>
  <p>通过这两个例子，我想大家对源程序的编制、编译和连接已有了大体的印象。而且也能发现COM和EXE两种可执行程序的差异： </p>
  <p>①   COM文件很短，不能超过64K，它只有一个段，代码、数据和堆栈都在一个段内；EXE文件可以很大，它可以有多个段，代码、数据和堆栈分散在不同的段内。<br />
    ②   COM文件的入口必须在代码段偏移100H处，而EXE程序的入口可以在任何位置，但如果不在代码段起始处，要在源程序中指明。</p>
  <div class="rpindex"><a href="4-15.html">下一页</a><a href="4-13.html">上一页</a> <a href="index.html">目录</a> </div>


<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
