<!--hmt-->
<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end --><!--end of htmlheader-->

<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->

<!--end of htmlmiddle-->



<h1> 6.4.&nbsp;如何设置复制</h1>

        
      
    
    <p>这里简单描述了如何为你当前的MySQL服务器设置完整的复制。假设你想要复制主服务器上的所有数据库，并且还没有配置的复制。你需要关闭主服务器来完成下面所列的步骤。</p>
    <p>下面的程序针对设置一个从服务器，你可以用来设置多个从服务器。</p>
    <p>虽然该方法是设置从服务器的最直接的途径，它并不是唯一的一个。例如，如果你有一个主服务器的数据快照，并且主服务器已经设置了服务器ID，启用了二进制日志，不需要关闭主服务器或停止对它的更新也可以设置从服务器。详情请参见<a href="replication-faq.html" title="6.9. Replication FAQ">6.9节，“复制FAQ”</a>。</p>
    <p>如果想要管理MySQL复制设置，我们建议你通读本章，并尝试<a href="" title="13.6.1. SQL Statements for Controlling Master Servers">13.6.1节，“用于控制主服务器的SQL语句”</a>和<a href="replication-howto.html" title="13.6.2. SQL Statements for Controlling Slave Servers">13.6.2节，“用于控制从服务器的SQL语句”</a>中的所有语句。还应熟悉<a href="replication-options.html" title="6.8. Replication Startup Options">6.8节，“复制启动选项”</a>中描述的复制启动选项。</p>
    <p>注释：该程序和后面章节所示的复制SQL语句需要SUPER权限。</p>
    <p>1.&nbsp;&nbsp;&nbsp;
      确保在服务器和从服务器上安装的MySQL版本与<a href="replication-compatibility.html" title="6.5. Replication Compatibility Between MySQL Versions">6.5节，“不同MySQL版本之间的复制兼容性”</a>所示的表兼容。理想情况，应在主服务器和从服务器上使用最近版本的MySQL。</p>
    <p>请先证实问题不是出现在最新的MySQL版本中再通报bug。</p>
    <p>2.&nbsp;&nbsp;&nbsp;
      在主服务器上为服务器设置一个连接账户。该账户必须授予REPLICATION 
      SLAVE权限。如果账户仅用于复制(推荐这样做)，则不需要再授予任何其它权限。(关于设置用户
      账户和权限的信息，参见<a href="" title="5.8. MySQL User Account Management">5.8节，“MySQL用户账户管理”</a>）。</p>
    <p>假定你的域为mydomain.com,想要创建用户名为repl的一个账户，从服务器可以使用该账户从你的域内的任何主机使用密码slavepass来访问主服务器。要创建该
      账户，可使用GRANT语句：</p>
    <pre >mysql&gt; GRANT REPLICATION SLAVE ON *.*
&nbsp;&nbsp;&nbsp; -&gt; TO &#39;repl&#39;@&#39;%.mydomain.com&#39; IDENTIFIED BY &#39;slavepass&#39;;</pre>
    <p>如果你计划从从属服务器主机使用LOAD 
      TABLE FROM MASTER或LOAD 
      DATA FROM MASTER语句，你需要授予该账户其它权限：</p>
    <p> ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      授予账户SUPER和RELOAD全局权限。</p>
    <p> ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      为所有想要装载的表授予SELECT权限。任何该
      账户不能SELECT的主服务器上的表被LOAD 
      DATA FROM MASTER忽略掉。</p>
    <p>3.&nbsp;&nbsp;&nbsp;
      执行FLUSH 
      TABLES WITH READ LOCK语句清空所有表和块写入语句：</p>
    <pre>4.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mysql&gt; FLUSH TABLES WITH READ LOCK；</pre>
    <p>对于InnoDB表，请注意：FLUSH 
      TABLES WITH READ LOCK还锁定COMMIT操作。当获得全局读锁定后，可以开始InnoDB表的文件系统快照。快照不能保证内部(在InnoDB存储引擎内部)一致性(因为InnoDB缓存没有刷新)，但并不需要关心该问题，因为InnoDB可以在启动时解决该问题并给出一致的结果。这说明InnoDB在启动快照时可以进行崩溃恢复，而不会破坏。然而，当保证一致的InnoDB表快照时，还没有途径来停止MySQL服务器。</p>
    <p>让客户程序保持运行，发出FLUSH 
      TABLES语句让读锁定保持有效。(如果退出客户程序，锁被释放）。然后对主服务器上的数据进行快照。</p>
    <p> 创建快照最简单的途径是使用归档程序对主服务器上的数据目录中的数据库进行二进制备份。例如，在Unix中使用tar，或者在Windows中使用PowerArchiver、WinRAR、WinZip或者类似的软件。要使用tar来创建包括所有数据库的归档文件，进入主服务器的数据目录，然后执行命令：</p>
    <pre >shell&gt; tar -cvf /tmp/mysql-snapshot.tar .</pre>
    <p>如果你想让归档只包括this_db数据库，应使用命令：</p>
    <pre >shell&gt; tar -cvf /tmp/mysql-snapshot.tar ./this_db</pre>
    <p>然后将归档文件复制到从服务器主机的/tmp目录。在该机器上，进入从服务器的数据目录，并使用下述命令解压缩归档文件：</p>
    <pre >shell&gt; tar -xvf /tmp/mysql-snapshot.tar</pre>
    <p>如果从服务器的用户账户与主服务器的不同，你可能不想复制mysql数据库。在这种情况下，应从归档中排除该数据库。你也不需要在归档中包括任何日志文件或者master.info或relay-log.info文件。</p>
    <p> 当FLUSH TABLES WITH READ 
      LOCK所置读锁定有效时，读取主服务器上当前的二进制日志名和偏移量值：</p>
    <pre >mysql &gt; SHOW MASTER STATUS;
+---------------+----------+--------------+------------------+
| File&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+---------------+----------+--------------+------------------+
| mysql-bin.003 | 73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | manual,mysql&nbsp;&nbsp;&nbsp;&nbsp; |
+---------------+----------+--------------+------------------+</pre>
    <p> File列显示日志名，而Position显示偏移量。在该例子中，二进制日志值为mysql-bin.003，偏移量为73。记录该值。以后设置从服务器时需要使用这些值。它们表示复制坐标，从服务器应从该点开始从主服务器上进行新的更新。</p>
    <p>取得快照并记录日志名和偏移量后，可以在主服务器上重新启用写活动：</p>
    <pre >mysql&gt; UNLOCK TABLES；</pre>
    <p>如果你正使用InnoDB表，理想情况应使用InnoDB 
      Hot Backup工具，使用该工具可以获得一致的快照而不需要在主服务器上进行锁定，并且可以对应从服务器上使用的快照来记录日志名和偏移量。Hot 
      Backup是一个附加的非免费(商业)工具，没有包含在标准 
      MySQL分发中。详细信息参见http://www.innodb.com/manual.html的InnoDB 
      Hot Backup主页。</p>
    <p>不使用Hot 
      Backup工具，最快捷的途径是使用InnoDB表的二进制快照来关闭主服务器并复制InnoDB数据文件、日志文件和表定义文件(.frm文件)。要记录当前的日志文件名和偏移量，关闭服务器之前应发出下面的语句：</p>
    <pre >mysql&gt; FLUSH TABLES WITH READ LOCK;
mysql&gt; SHOW MASTER STATUS;</pre>
    <p>然后记录前面所示的SHOW MASTER 
      STATUS的输出中显示的日志名和偏移量。记录日志名和偏移量后，<i>不</i>解锁表关闭服务器以确保&nbsp;
      服务器关闭时的快照与当前的日志文件和偏移量相对应：</p>
    <pre >shell&gt; mysqladmin -u root shutdown</pre>
    <p>适合MyISAM和InnoDB表的另一个方法是对主服务器上的SQL进行转储而不是对前面讨论的二进制复制进行转储。为了实现，可以在主服务器上使用mysqldump 
      --master-data，以后将SQL转储文件装入从服务器。但是，这样比二进制复制要慢一些。</p>
    <p>如果主服务器运行时没有启用--logs-bin，SHOW 
      MASTER STATUS或mysqldump 
      --master-data显示的日志名和位置值为空。在这种情况下，当以后指定从服务器的日志文件和位置时需要使用的值为空字符串(&#39;&#39;)和4.</p>
    <p>5.&nbsp;&nbsp;&nbsp;
      确保主服务器主机上my.cnf文件的[mysqld]部分包括一个log-bin选项。该部分还应有一个server-id=Master_id选项，其中master_id必须为1到2<sup>32</sup>–1之间的一个正整数值。例如：</p>
    <pre>6.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [mysqld]
7.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log-bin=mysql-bin
8.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server-id=1</pre>
    <p>如果没有提供那些选项，应添加它们并重启服务器。</p>
    <p>9.&nbsp;&nbsp;&nbsp;
      停止用于从服务器的服务器并在其my.cnf文件中添加下面的行：</p>
    <pre>10.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [mysqld]
11.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server-id=slave_id</pre>
    <p> slave_id值同Master_id值一样，必须为1到2<sup>32</sup>–1之间的一个正整数值。并且，从服务器的ID必须与主服务器的ID不相同。例如：</p>
    <pre >[mysqld]
server-id=2</pre>
    <p>如果设置多个从服务器，每个从服务器必须有一个唯一的server-id值，必须与主服务器的以及其它从服务器的不相同。可以认为server-id值类似于IP地址：这些ID值能唯一识别复制服务器群集中的每个服务器实例。</p>
    <p>如果不指定一个server-id值，如果没有定义master-host，则将它设置为1；否则设置为2。请注意如果server-id太长，主服务器 
      拒绝所有来自从服务器的连接，并且从服务器拒绝连接到主服务器。这样，省略server-id只适合用二进制日志备份。</p>
    <p>12.如果对主服务器的数据进行二进制备份，启动从服务器之前将它复制到从服务器的数据目录中。确保对这些文件和目录的权限正确。服务器 
      MySQL运行的用户必须能够读写文件，如同在主服务器上一样。</p>
    <p>如果使用mysqldum备份，先启动从服务器(看下一步)。</p>
    <p>13.启动从服务器。如果前面已经复制了，用--skip-slave-start选项启动从服务器，以便它不立即尝试连接主服务器。你也可能想要用--logs-warnings选项启动从服务器(默认设置启用)，以便在错误日志中显示更多的问题相关的信息(例如，网络或连接问题)。放弃的连接将记入错误日志，除非其值大于1。</p>
    <p>14.如果使用mysqldump备份主服务器的数据，将转储文件装载到从服务器：</p>
    <pre>15.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shell&gt; mysql -u root -p &lt; dump_file.sql
16.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在从服务器上执行下面的语句，用你的系统的实际值替换选项值：
17.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mysql&gt; CHANGE MASTER TO
18.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp; MASTER_HOST=&#39;master_host_name&#39;,
19.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp; MASTER_USER=&#39;replication_user_name&#39;,
20.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp; MASTER_PASSWORD=&#39;replication_password&#39;,
21.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp; MASTER_LOG_FILE=&#39;recorded_log_file_name&#39;,
22.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp; MASTER_LOG_POS=recorded_log_position;</pre>
    <p>下面的表显示了字符串选项的最大长度：</p>
    <table border="1" cellpadding="0" id="table3">
      <tr>
        <td><p> Master_Host</td>
        <td><p>60</td>
      </tr>
      <tr>
        <td><p> Master_USER</td>
        <td><p>16</td>
      </tr>
      <tr>
        <td><p> Master_PASSWORD</td>
        <td><p>32</td>
      </tr>
      <tr>
        <td><p> Master_Log_File</td>
        <td><p>255</td>
      </tr>
    </table>
    <p>23.启动从服务器线程：</p>
    <pre>24.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mysql&gt; START SLAVE；</pre>
    <p>执行这些程序后，从服务器应连接主服务器，并补充自从快照以来发生的任何更新。</p>
    <p>如果你忘记设置主服务器的server-id值，从服务器不能连接主服务器。</p>
    <p>如果你忘记设置从服务器的server-id值，在从服务器的错误日志中会出现下面的错误：</p>
    <pre>Warning: You should set server-id to a non-0 value if master_host is set;
we will force server id to 2, but this MySQL server will not act as a slave.</pre>
    <p>如果由于其它原因不能复制，从服务器的错误日志中也会出现错误消息。</p>
    <p>从服务器复制时，会在其数据目录中发现文件dmaster.info和relay-log.info。从服务器使用这两个文件跟踪已经处理了多少主服务器的二进制日志。不要移除或编辑这些文件，除非你确切知你正在做什么并完全理解其意义。即使这样，最好是使用CHANGE 
      MASTER TO语句。</p>
    <p>注释：master.info的内容会覆盖命令行或in
      
      my.cnf中指定的部分选项。详情参见<a href="replication-options.html" title="6.8. Replication Startup Options">6.8节，“复制启动选项”</a>。</p>
    <p>有了一个快照，你可以用它根据刚刚描述的从服务器部分来设置其它从服务器。你不需要主服务器的另一个快照；每个从服务器可以使用相同的快照。</p>
    <p>注释：为了保证事务InnoDB复制设置的最大可能的耐受性和一致性，应在主服务器的my.cnf文件中使用innodb_flush_log_at_trx_commit=1和sync-binlog=1。
  
  
    
      
        
          


<!--start of htmlend-->
<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->