<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end --><!--end of htmlheader-->

<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->

<!--end of htmlmiddle-->



<div class="g-unit" id="gc-pagecontent">


<div id="jd-content">

<div class="jd-descr">
<h2>教程: 练习 3</h2>

<p><em>在这章练习中, 你将用生命周期事件回调去存储和获得
应用程序的状态代码. 这个练习描述了:</em></p>
<ul>
<li><em>生命周期函数及你的程序如何调用它</em></li>
<li><em>维护程序状态的技术</em></li>
</ul>

<div style="float:right;white-space:nowrap">
	[<a href="tutorial-ex1.html">练习 1</a>]
	[<a href="tutorial-ex2.html">练习 2</a>]
	<span style="color:#BBB;">
		[<a href="tutorial-ex3.html" style="color:#BBB;">练习 3</a>]
	</span>
	[<a href="tutorial-extra-credit.html">额外练习</a>]
</div>

<h2>步骤 1</h2>

<p>将 <code>Notepadv3</code> 导入Eclipse. 如果你看到一个关于
<code>AndroidManifest.xml,</code> 的错误，或者一些与Android.zip文件有关的问题, 
右击工程然后从弹出的按钮中选择<strong>Android Tools(Android工具)</strong> &gt;
<strong>修正工程属性</strong> . 此练习的起点正是Nodepadv2的结束处。 </p>
<p>当前应用程序存在问题 &mdash; 点击返回按钮当编辑工作会失败，
，还有其他的一些在编辑过程中产生的问题也会导致编辑内容丢失.</p>
<p>要修正这个问题, 我们需要将创建和编辑记事本的大多数功能（函数）放进 NoteEdit类, 并且为编辑记事本
制定完整的生命周期。</p>

  <ol>
    <li>删除 <code>NoteEdit</code> 里的那些从附加束里分析标题和主题的代码. 
    <p>相反（相对于上面的方法）, 我们将用 <code>DBHelper</code> 这个类
    直接从数据库访问记事本. 我们所需传进
    NoteEdit Activity 的是一个 <code>mRowId</code> (但仅仅是我们编辑的时候，如果我们执行的是创建
	操作，我们什么也不用传进去).删除这些行:</p>
      <pre>
String title = extras.getString(NotesDbAdapter.KEY_TITLE);
String body = extras.getString(NotesDbAdapter.KEY_BODY);</pre>
    </li>
    <li>被传进<code>extras</code> Bundle的那些属性我们也不需要了, 这些属性只是被我们用来
	在UI上编辑body文本的. 所以删除:
    <pre>
if (title != null) {
    mTitleText.setText(title);
}
if (body != null) {
    mBodyText.setText(body);
}</pre>
    </li>
  </ol>
  
<h2>步骤 2</h2>

<p>在NoteEdit类的顶部为<code>NotesDbAdapter</code> 创建一个类对象：</p>
    <pre>&nbsp;&nbsp;&nbsp; private NotesDbAdapter mDbHelper;</pre>
<p>也在函数<code>onCreate()</code>中为 <code>NotesDbAdapter</code>添加一个实例
 (紧接着在<code>super.onCreate()</code> 调用后):</p>
    <pre>
&nbsp;&nbsp;&nbsp; mDbHelper = new NotesDbAdapter(this);<br>
&nbsp;&nbsp;&nbsp; mDbHelper.open();</pre>
    
<h2>步骤 3</h2>

<p>在 <code>NoteEdit</code>, 我们需要为<code>mRowId</code>检查<var>savedInstanceState</var> 
, 以防编辑含有束中的已保存的状态, 而这些是我们需要覆盖掉的状态 (这会发生在activity
失去焦点并被重启的时候).</p>
  <ol>
    <li>
      替换当前初始化 <code>mRowId</code>的代码:<br>
      <pre>
        mRowId = null;

        Bundle extras = getIntent().getExtras();
        if (extras != null) {
            mRowId = extras.getLong(NotesDbAdapter.KEY_ROWID);
        }
        </pre>
        用以下代码替换:
        <pre>
        mRowId = savedInstanceState != null ? savedInstanceState.getLong(NotesDbAdapter.KEY_ROWID) 
                                            : null;
        if (mRowId == null) {
            Bundle extras = getIntent().getExtras();            
            mRowId = extras != null ? extras.getLong(NotesDbAdapter.KEY_ROWID) 
                                    : null;
        }
        </pre>
    </li>
    <li>
      为 <code>savedInstanceState</code>标注空值检查， 并且仍需从<code>extras</code> Bundle
	  加载<code>mRowId</code>:如果<code>savedInstanceState</code>没有为它提供.这是一个可用来快速安全使用
	  值的三元操作符，当然如果没有提供，它会是空。
    </li>
  </ol>
  
<h2>步骤 4</h2>

<p>接下来, 如果我们有<code>mRowId</code>，我们需要在它之上产生相关的域(fields):</p>
    <pre>populateFields();</pre>
    <p>这个动作需要在<code>confirmButton.setOnClickListener()</code>前做，
    这个方法将在呆会定义。</p>

<h2>步骤 5</h2>

<p>无需<code>onClick()</code>处理函数里创建bundle和设置bundle值，
    Activity 也不再用返回任何附加信息给调用者。
    因为我们无需返回值，我们可以用<code>setResult()</code>的简化版：
</p>
    <pre>
public void onClick(View view) {
    setResult(RESULT_OK);
    finish();
}</pre>
    <p>使用生命周期函数时，要谨记将更新和方法说明存储到数据库。</p>
    
    <p>整个 <code>onCreate()</code> 函数应该如此:</p>
    <pre>
super.onCreate(savedInstanceState);
 
mDbHelper = new NotesDbAdapter(this);
mDbHelper.open();
 
setContentView(R.layout.note_edit);
 
mTitleText = (EditText) findViewById(R.id.title);
mBodyText = (EditText) findViewById(R.id.body);
 
Button confirmButton = (Button) findViewById(R.id.confirm);
 
mRowId = savedInstanceState != null ? savedInstanceState.getLong(NotesDbAdapter.KEY_ROWID) 
                                    : null;
if (mRowId == null) {
    Bundle extras = getIntent().getExtras();
    mRowId = extras != null ? extras.getLong(NotesDbAdapter.KEY_ROWID) 
                            : null;
}
 
populateFields();
 
confirmButton.setOnClickListener(new View.OnClickListener() {

    public void onClick(View view) {
        setResult(RESULT_OK);
        finish();
    }
     
});</pre>

<h2>步骤 6</h2>

<p>定义<code>populateFields()</code> 方法.</p>
    <pre>
private void populateFields() {
    if (mRowId != null) {
        Cursor note = mDbHelper.fetchNote(mRowId);
        startManagingCursor(note);
        mTitleText.setText(note.getString(
	            note.getColumnIndexOrThrow(NotesDbAdapter.KEY_TITLE)));
        mBodyText.setText(note.getString(
                note.getColumnIndexOrThrow(NotesDbAdapter.KEY_BODY)));
    }
}</pre>
<p>该方法用了 <code>NotesDbAdapter.fetchNote()</code> 方法去找到要编辑的说明（标注）
, 然后它调用<code>Activity</code> 类的<code>startManagingCursor()</code> 方法 , 这是Android提供的一个
跟踪光标生命周期的方法. 然后将按照Activity生命周期所描述的一样：释放和创建资源, 而无需我们担心
. 在那之后, 我们只需从光标处获得标题和主体，并且产生它们的视图元素。</p>
 

<h2>步骤 7</h2>

    <div class="sidebox" style="border:2px solid #FFFFDD;float:right;
      background-color:#FFFFEE;margin-right:0px;margin-bottom:.5em;
      margin-top:1em;padding:0em;width:240px;">
      <h2 style="border:0;font-size:12px;padding:.5em .5em .5em 1em;margin:0;
      background-color:#FFFFDD;">为什么处理生命周期时间非常重要</h2>
      <p style="padding-left:.5em;font-size:12px;margin:0; 
     padding:.0em .5em .5em 1em;">如果你习惯了总是控制着你的应用程序, 你可能会不能明白为何必需要
	这些整个生命周期都存在的东西。其实原因是：在Android，是操作系统，而不是你在控制着程序的运
	 作！</p>
      <p style="padding-left:.5em;font-size:12px;margin:0; 
     padding:.0em .5em .5em 1em;">正如我们所看到的，Android模型是基于Activities的相互调用的. 当
	 一个Activity调用另外一个时，至少当前的Activity被暂时停止掉，在操作系统运行资源不足时，
	 也有可能两个都被停掉。如果这种情况真的发生，那么该Activity必须保存足够的状态信息，以期恢复。
	 最好就是保存它被停掉时的状态.</p>
      <p style="padding-left:.5em;font-size:12px;margin:0;padding:.0em .5em .5em 1em;">
      Android有一个 <a href="../intro/lifecycle.html">明确的生命周期</a>.
      即使你没有显式地将控制权交个一个Activity，它生命周期时间也有可能会发生. 比如说，当有电话打
	  进你的手机，而当时你手机上某个Activity正在运行，那么当前运行的Activity将被交换（系统资源控制权转换）
      而电话Activity将运行（占有资源控制权）.</p>
    </div>

<p>还是在 <code>NoteEdit</code> 类, 现在覆盖这些方法：
   <code>onSaveInstanceState()</code>, <code>onPause()</code> 及 
   <code>onResume()</code>. 这些都是已有的<code>onCreate()</code>函数附带的方法。
 </p>

<p>当某Activity将被停止掉<strong>有可能在重启之前被杀掉</strong>, Android将会调用
   <code>onSaveInstanceState()</code> 这将意味着任何有用的状态信息将被保存，以使该Activity
    重启时能被重新初始化. 这是和 <code>onCreate()</code> 方法对应的, 实际上
    被传进 <code>onCreate()</code>的<code>savedInstanceState</code> 的Bundle 正是你在<code>onSaveInstanceState()</code>
	中作为<code>outState</code>（暂失效状态）创建的bundle.
</p>

<p><code>onPause()</code> 与 <code>onResume()</code> 也是自动调用的方法. <code>onPause()</code> 总是在一个
    Activity结束时被调用，即使我们特意调用了<code>finish()</code>。我们将用这个去将当前的标注保存到数据
	库。为了减少被占用的资源，良好做法是在<code>onPause()</code>期间尽量释放任何能被释放的资源. 因此我们关掉DbHelper类，
	并将它的域设为空，使得它能被适时回收。
    另一方面，<code>onResume()</code> 能重建
    <code>mDbHelper</code> 实例以使我们能够使用它。 然后从数据库中将标注重新读出，并且产生新的域。
</p>

<p>因此，在 <code>populateFields()</code> 方法后留空以添加以下的一些生命周期的方法：
</p>
  <ol type="a">
    <li><code>
      onSaveInstanceState()</code>:
      <pre>
    &#64;重写
    protected void onSaveInstanceState(Bundle outState) {
        super.onSaveInstanceState(outState);
        outState.putLong(NotesDbAdapter.KEY_ROWID, mRowId);
    }</pre>
    </li>
    <li><code>
      onPause()</code>:
      <pre>
    &#64;重写
    protected void onPause() {
        super.onPause();
        saveState();
    }</pre>
    <p>We'll define <code>saveState()</code> next.</p>
    </li>
    <li><code>
      onResume()</code>:
      <pre>
    &#64;重写
    protected void onResume() {
        super.onResume();
        populateFields();
    }</pre>
    </li>
  </ol>


<h2 style="clear:right;">Step 8</h2>

<p>定义 <code>saveState()</code> 方法以把数据读出到数据库.</p>
    <pre>
     private void saveState() {
        String title = mTitleText.getText().toString();
        String body = mBodyText.getText().toString();

        if (mRowId == null) {
            long id = mDbHelper.createNote(title, body);
            if (id > 0) {
                mRowId = id;
            }
        } else {
            mDbHelper.updateNote(mRowId, title, body);
        }
    }</pre>
  <p>注意到我们接受了 <code>createNote()</code> 的返回值，如果该值有效，我们将它保存到 <code>mRowId</code> 字段，
     这样我们就能在将来更新之，而不用再重建一个。 (重建也可能会发生在生命周期事件被触发时).
  </p>


<h2 style="clear:right;">步骤 9</h2>

<p>现在拿出先前的在<code>Notepadv3</code>类 <code>onActivityResult()</code> 方法中定义的处理代码
</p>
<p>所有的标注检索和更新都发生在<code>NoteEdit</code> 生命周期内, 因此所有的 <code>onActivityResult()</code>
    方法需要做的就是更新数据视图，不需要其他的工作了。
    该方法如下：</p>
<pre>
&#64;重写
protected void onActivityResult(int requestCode, int resultCode, 
                                Intent intent) {
    super.onActivityResult(requestCode, resultCode, intent);
    fillData();
}</pre>

<p>因为另外一个类正在做这个工作，这个函数所需的做的就是更新数据.</p>
 
<h2>步骤 10</h2>

<p>将<code>onListItemClick()</code> 方法里设置标题和主体的代码移除 (一样，它们都是无需的, 
   除了<code>mRowId</code> ):</p>
<pre>
    Cursor c = mNotesCursor;
    c.moveToPosition(position);</pre>
<br>
也移除:
<br>
<pre>
    i.putExtra(NotesDbAdapter.KEY_TITLE, c.getString(
                    c.getColumnIndex(NotesDbAdapter.KEY_TITLE)));
    i.putExtra(NotesDbAdapter.KEY_BODY, c.getString(
                    c.getColumnIndex(NotesDbAdapter.KEY_BODY)));</pre>
<br>
因此剩下的代码应是:
<br>
<pre>
    super.onListItemClick(l, v, position, id);
    Intent i = new Intent(this, NoteEdit.class);
    i.putExtra(NotesDbAdapter.KEY_ROWID, id);
    startActivityForResult(i, ACTIVITY_EDIT);</pre>

  <p>现在也可以将mNotesCursor从类中移除, 而在<code>fillData()</code> 方法中用一个局部变量将它
     设回:
<br><pre>
    Cursor notesCursor = mDbHelper.fetchAllNotes();</pre></p>
  <p>注意到 <code>m</code> 在 <code>mNotesCursor</code> 代表着成员域（成员变量）, 因此当
  使 <code>notesCursor</code> 成为一个局部变量, 要去掉 <code>m</code>. 记得在<code>fillData()</code>
  方法中重命名所有的<code>mNotesCursor</code>。
</ol>
<p>
运行之! (在Project上单击右键 -> <em>Run As -&gt; Android Application</em> )</p>

<h2>解决方案与下一步骤</h2>

<p>你可以在从zip file中找到<code>Notepadv3Solution</code>，并在里面查看关于这一练习的解决方案
   以对比你自己的.</p>
<p>
如果准备好了, 转到 <a href="../intro/tutorial-extra-credit.html">额外教程</a> 练习, 这里你可以用eclipse debugger去查生命周期事件.</p>
<p><a href="../intro/tutorial.html">回到教程主菜单...</a></p>

</div>

</div>
</div><!-- end gc-pagecontent -->



<!--start of htmlend-->
<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
