<!-- header-start -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/include/js/jquery.min.js" language="javascript"></script>
<script src="/include/js/jquery-ui.min.js" language="javascript"></script>
<link href="/include/css/jquery-ui.min.css" rel="stylesheet" type="text/css" />
<link href="/include/css/main.css" rel="stylesheet" type="text/css" />

<SCRIPT>
	$(document).ready(function() {
		$( "#menu" ).menu({ position: { my: "left top", at: "right-100 top+35" } });
	});
</SCRIPT>

<!-- header-end -->
<!-- middle-start -->
﻿
<base target="_blank" />
</head>
<body>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- topmenu-start -->
<header>
    <section id="global-nav">
        <nav>
            <ul class="projects">
                    <li><a href="/">ITeedu.com</a></li>
            </ul>
            <ul class="links">
                    <li><a>快捷导航</a>
                        <ul>
                            <li><a href="/plang/">编程语言</a></li>
                            <li><a href="/webtech/">WEB开发</a></li>
                            <li><a href="/handset/">手机开发</a></li>
                            <li><a href="/database/">数据库</a></li>
                            <li><a href="/os/">操作系统</a></li>
                            <li><a href="/embed/">嵌入式</a></li>
                            <li><a href="/opensource/">开源软件</a></li>
                            <li><a href="/works/">作品</a></li>

                        </ul>
                    </li>
                    <li><a href="/plang/asm/">编辑语言</a>
                        <ul>
                                <li><a href="/plang/asm/">汇编</a></li>
                                <li><a href="/plang/ccpp/">C/C++</a> </li>
                                <li><a href="/plang/java/">JAVA</a> </li>
                                <li><a href="/plang/python/">Python</a> </li>
                                <li><a href="/plang/ruby/">Ruby</a></li>
                        </ul>
                    </li>
                    <li><a href="/webtech/">WEB开发</a>
                        <ul>
                            <li><a href="/webtech/javascript/">javascript</a> </li>
                            <li><a href="/webtech/j2ee/">J2EE</a> </li>
                            <li><a href="/webtech/php/">PHP</a> </li>
                            <li><a href="/webtech/python/djangocn2/">Django</a> </li>
                        </ul>
                    </li>
					<li><a href="/me/contactme.htm">关于</a></li>
            </ul>
        </nav>
    </section>
</header>
<!-- topmenu-end -->

<div id="container" style="margin: 35px 120px 0px 120px;">
	<div id="logo-wapper">
		<div style="float:left;width:150px;" ><h1 class="logo">ITEEDU</h1></div>
		<div style="float:right;width:760px">

		</div>
		<div style="clear:both;"></div>
	</div>
<nav id="main-nav">
<!-- menunav-start -->
<div id="menu">
    <li><a href="/plang/">编程语言</a>
        <ul>
            <LI><a href="/plang/asm/">汇编</a></LI>
            <LI><a href="/plang/ccpp/">C/C++</a> </LI>
            <LI><a href="/plang/java/">JAVA</a> </LI>
            <LI><a href="/plang/python/">Python</a> </LI>
            <LI><a href="/plang/ruby/">Ruby</a></LI>
        </ul>
    </li>
    <li><a href="/webtech/index.php">WEB开发</a>
        <ul>
            <LI><a href="/webtech/j2ee/">J2EE</a></LI>
            <LI><a href="/webtech/php/">PHP</a> </LI>
            <LI><a href="/webtech/python/djangocn2/">djangocn2</a> </LI>
        </ul>
    </li>
    <li><a href="/handset/index.php">手机开发</a>
        <ul>
            <LI><a href="/handset/android/">android</a></LI>
            <LI><a href="/handset/iphone/">iphone</a> </LI>
        </ul>
    </li>
    <li><a href="/database/index.php">数据库</a>
        <ul>
            <LI><a href="/database/mysql/">MYSQL</a></LI>
            <LI><a href="/database/sqlite/">sqlite</a></LI>
    	</ul>
    </li>
    <li><a href="/os/">操作系统</a>
        <ul>
        	<LI><a href="/os/linux/">Linux</a></LI>
        	<LI><a href="/os/grub/">GRUB</a></LI>
    	</ul>
     </li>
     <li><a href="/embed/">嵌入式</a></li>
     <li><a href="/opensource/">开源软件</a></li>
</div>
<!-- menunav-end -->
</nav>
<div id="content-wrapper">
<div id="file-wrapper">


<!-- middle-end -->



<div class="lpindex"><a href="index.html">首页</a><a href="21.html"> 上一页</a><a href="23.html"> 下一页</a></div>
<h2>6.3. 值集合和多对多关联(Collections of Values and Many To Many   Associations)</h2>
<p>任何值集合和实体集合如果被映射为多对多关联(Java集合中的语义)就需要一个集合表。这个表中包含外键字段,元素字段还可能有索引字段。 </p>
<p>使用&lt;key&gt;元素来申明从集合表到其拥有者类的表(from the collection   table to the table of the owning class)的外键关键字。 </p>
<pre class="code">&lt;key column=&quot;column_name&quot;/&gt;</pre>
<table summary="Callout list" border="0">
  <tbody>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="1" src="images/callouts/1.png" border="0" /></td>
      <td valign="top" align="left"><p>column(必需):外键字段的名称 </p></td>
    </tr>
  </tbody>
</table>
<p>对于类似与map和list的带索引的集合, 我们需要一个&lt;index&gt;元素。对于list来说,   这个字段包含从零开始的连续整数。对于map来说,这个字段可以包含任意Hibernate类型的值。 </p>
<pre class="code">&lt;index
        column=&quot;column_name&quot;                <span class="co"><img src="images/callouts/1.png" alt="(1)" /></span>
        type=&quot;typename&quot;                     <span class="co"><img src="images/callouts/2.png" alt="(2)" /></span>
/&gt;</pre>
<table summary="Callout list" border="0">
  <tbody>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="1" src="images/callouts/1.png" border="0" /></td>
      <td valign="top" align="left"><p>column(必需):保存集合索引值的字段名。 </p></td>
    </tr>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="2" src="images/callouts/2.png" border="0" /></td>
      <td valign="top" align="left"><p>type (可选,默认为整型integer):集合索引的类型。 </p></td>
    </tr>
  </tbody>
</table>
<p>还有另外一个选择,map可以是实体类型的对象。在这里我们使用&lt;index-many-to-many&gt;元素。 </p>
<pre class="code">&lt;index-many-to-many
        column=&quot;column_name&quot;                <span class="co"><img src="images/callouts/1.png" alt="(1)" /></span>
        class=&quot;ClassName&quot;                   <span class="co"><img src="images/callouts/2.png" alt="(2)" /></span>
/&gt;</pre>
<table summary="Callout list" border="0">
  <tbody>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="1" src="images/callouts/1.png" border="0" /></td>
      <td valign="top" align="left"><p>column(必需):集合索引值中外键字段的名称 </p></td>
    </tr>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="2" src="images/callouts/2.png" border="0" /></td>
      <td valign="top" align="left"><p>class (required):(必需):集合的索引使用的实体类。 </p></td>
    </tr>
  </tbody>
</table>
<p>对于一个值集合, 我们使用&lt;element&gt;标签。 </p>
<pre class="code">&lt;element
        column=&quot;column_name&quot;                <span class="co"><img src="images/callouts/1.png" alt="(1)" /></span>
        type=&quot;typename&quot;                     <span class="co"><img src="images/callouts/2.png" alt="(2)" /></span>
/&gt;</pre>
<table summary="Callout list" border="0">
  <tbody>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="1" src="images/callouts/1.png" border="0" /></td>
      <td valign="top" align="left"><p>column(必需):保存集合元素值的字段名。 </p></td>
    </tr>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="2" src="images/callouts/2.png" border="0" /></td>
      <td valign="top" align="left"><p>type (必需):集合元素的类型 </p></td>
    </tr>
  </tbody>
</table>
<p>一个拥有自己表的实体集合对应于<em>多对多(many-to-many)关联</em>关系概念。多对多关联是针对Java集合的最自然映射关联关系，但通常并不是最好的关系模型。 </p>
<p>&nbsp;</p>
<pre class="code">&lt;many-to-many
        column=&quot;column_name&quot;                               <span class="co"><img src="images/callouts/1.png" alt="(1)" /></span>
        class=&quot;ClassName&quot;                                  <span class="co"><img src="images/callouts/2.png" alt="(2)" /></span>
        outer-join=&quot;true|false|auto&quot;                       <span class="co"><img src="images/callouts/3.png" alt="(3)" /></span>
/&gt;</pre>
<table summary="Callout list" border="0">
  <tbody>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="1" src="images/callouts/1.png" border="0" /></td>
      <td valign="top" align="left"><p>column(必需): 这个元素的外键关键字段名 </p></td>
    </tr>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="2" src="images/callouts/2.png" border="0" /></td>
      <td valign="top" align="left"><p>class (必需): 关联类的名称 </p></td>
    </tr>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="3" src="images/callouts/3.png" border="0" /></td>
      <td valign="top" align="left"><p>outer-join (可选 - 默认为auto):   在Hibernate系统参数中hibernate.use_outer_join被打开的情况下,该参数用来允许使用outer join来载入此集合的数据。 </p></td>
    </tr>
  </tbody>
</table>
<p>例子： </p>
<p>首先, 一组字符串： </p>
<pre class="code">&lt;set name=&quot;names&quot; table=&quot;NAMES&quot;&gt;
    &lt;key column=&quot;GROUPID&quot;/&gt;
    &lt;element column=&quot;NAME&quot; type=&quot;string&quot;/&gt;
&lt;/set&gt;</pre>
<p>包含一组整数的bag(还设置了order-by参数指定了迭代的顺序)：</p>
<pre class="code">&lt;bag name=&quot;sizes&quot; table=&quot;SIZES&quot; order-by=&quot;SIZE ASC&quot;&gt;
    &lt;key column=&quot;OWNER&quot;/&gt;
    &lt;element column=&quot;SIZE&quot; type=&quot;integer&quot;/&gt;
&lt;/bag&gt;</pre>
<p>一个实体数组,在这个案例中是一个多对多的关联(注意这里的实体是自动管理生命周期的对象（lifecycle objects）,cascade=&quot;all&quot;): </p>
<pre class="code">&lt;array name=&quot;foos&quot; table=&quot;BAR_FOOS&quot; cascade=&quot;all&quot;&gt;
    &lt;key column=&quot;BAR_ID&quot;/&gt;
    &lt;index column=&quot;I&quot;/&gt;
    &lt;many-to-many column=&quot;FOO_ID&quot; class=&quot;com.illflow.Foo&quot;/&gt;
&lt;/array&gt;</pre>
<p>一个map,通过字符串的索引来指明日期：</p>
<pre class="code">&lt;map name=&quot;holidays&quot; table=&quot;holidays&quot; schema=&quot;dbo&quot; order-by=&quot;hol_name asc&quot;&gt;
    &lt;key column=&quot;id&quot;/&gt;
    &lt;index column=&quot;hol_name&quot; type=&quot;string&quot;/&gt;
    &lt;element column=&quot;hol_date&quot; type=&quot;date&quot;/&gt;
&lt;/map&gt;</pre>
<p>一个组件的列表： </p>
<pre class="code">&lt;list name=&quot;carComponents&quot; table=&quot;car_components&quot;&gt;
    &lt;key column=&quot;car_id&quot;/&gt;
    &lt;index column=&quot;posn&quot;/&gt;
    &lt;composite-element class=&quot;com.illflow.CarComponent&quot;&gt;
            &lt;property name=&quot;price&quot; type=&quot;float&quot;/&gt;
            &lt;property name=&quot;type&quot; type=&quot;com.illflow.ComponentType&quot;/&gt;
            &lt;property name=&quot;serialNumber&quot; column=&quot;serial_no&quot; type=&quot;string&quot;/&gt;
    &lt;/composite-element&gt;
&lt;/list&gt;</pre>
<h2><a name="6-4" id="6-4"></a>6.4. 一对多关联（One   To Many Associations）</h2>
<p><em>一对多关联</em><em>直接</em>连接两个类对应的表,而没有中间集合表。(这实现了一个<em>一对多</em>的关系模型)(译者注:这有别与多对多的关联需要一张中间表)。   这个关系模型失去了一些Java集合的语义: </p>
<ul type="disc" compact="compact">
  <li>
    <p>map,set或list中不能包含null值 </p>
  </li>
  <li>
    <p>一个被包含的实体的实例只能被包含在一个集合的实例中 </p>
  </li>
  <li>
    <p>一个被包含的实体的实例只能对应于集合索引的一个值中 </p>
  </li>
</ul>
<p>一个从Foo到Bar的关联需要额外的关键字字段,可能还有一个索引字段指向这个被包含的实体类,Bar所对应的表。这些字段在映射时使用前面提到的&lt;key&gt;和&lt;index&gt;元素。 </p>
<p>&lt;one-to-many&gt;标记指明了一个一对多的关联。 </p>
<pre class="code">&lt;one-to-many class=&quot;ClassName&quot;/&gt;</pre>
<table summary="Callout list" border="0">
  <tbody>
    <tr>
      <td valign="top" align="left" width="5%"><img alt="1" src="images/callouts/1.png" border="0" /></td>
      <td valign="top" align="left"><p>class(必须):被关联类的名称。 </p></td>
    </tr>
  </tbody>
</table>
<p>例子 </p>
<pre class="code">&lt;set name=&quot;bars&quot;&gt;
    &lt;key column=&quot;foo_id&quot;/&gt;
    &lt;one-to-many class=&quot;com.illflow.Bar&quot;/&gt;
&lt;/set&gt;</pre>
<p>注意:&lt;one-to-many&gt;元素不需要定义任何字段。 也不需要指定表名。 </p>
<p><em>重要提示</em>:如果一对多关联中的&lt;key&gt;字段定义成NOT   NULL,那么当创建和更新关联关系时Hibernate可能引起约束违例。为了预防这个问题,<em>你必须使用双向关联</em>，并且在“多”这一端（Set或者是bag)指明inverse=&quot;true&quot;。 </p>
<h2><a name="6-5" id="6-5"></a>6.5. 延迟初始化(延迟加载)（Lazy Initialization）</h2>
<p>(译者注: 本翻译稿中，对Lazy Initiazation和Eager   fetch中的lazy,eager采取意译的方式，分别翻译为延迟初始化和预先抓取。lazt initiazation就是指直到第一次调用时才加载。） </p>
<p>集合(不包括数组)是可以延迟初始化的,意思是仅仅当应用程序需要访问时，才载入他们的值。对于使用者来说，初始化是透明的,   因此应用程序通常不需要关心这个(事实上,透明的延迟加载也就是为什么Hibernate需要自己的集合实现的主要原因)。但是, 如何应用程序试图执行以下程序: </p>
<pre class="code">s = sessions.openSession();
User u = (User) s.find(&quot;from User u where u.name=?&quot;, userName, Hibernate.STRING).get(0);
Map permissions = u.getPermissions();
s.connection().commit();
s.close();

Integer accessLevel = (Integer) permissions.get(&quot;accounts&quot;);  // Error!</pre>
<p>这个错误可能令你感到意外。因为在这个Session被提交(commit)之前,   permissions没有被初始化,那么这个集合将永远不能载入他的数据了。 解决方法是把读取集合数据的语句提到Session被提交之前。 </p>
<p>另外一种选择是不使用延迟初始化集合。既然延迟初始化可能引起上面这样错误,默认是不使用延迟初始化的。但是, 为了效率的原因,   我们希望对绝大多数集合(特别是实体集合)使用延迟初始化。 </p>
<p>延迟初始化集合时发生的例外被封装在LazyInitializationException中。 </p>
<p>使用可选的 lazy 属性来定义延迟初始化集合： </p>
<pre class="code">&lt;set name=&quot;names&quot; table=&quot;NAMES&quot; lazy=&quot;true&quot;&gt;
    &lt;key column=&quot;group_id&quot;/&gt;
    &lt;element column=&quot;NAME&quot; type=&quot;string&quot;/&gt;
&lt;/set&gt;</pre>
<p>在一些应用程序的体系结构中,特别是使用hibernate访问数据的结构, 代码可能会用在不用的应用层中, 可能没有办法保证当一个集合在初始化的时候,   session仍然打开着。 这里有两个基本方法来解决这个问题： </p>
<ul type="disc">
  <li>
    <p>在基于Web的应用程序中, 一个servlet过滤器可以用来在用户请求的完成之前来关闭Session。当然,这个地方(关闭session)严重依赖于你的应用程序结构中例外处理的正确性。在请求返回给用户之前关闭Session和结束事务是非常重要的,即使是在构建视图(译者注:   返回给用户的HTML页面)的时候发生了例外,也必须确保这一点。考虑到这一点，servlet过滤器可以保证能够操作这个Session。我们推荐使用一个ThreadLocal变量来保存当前的Session。 </p>
  </li>
  <li>
    <p>在一个有单独的商业层的应用程序中, 商业逻辑必须在返回之前“准备好”Web层所需要的所有集合。通常, 应用程序为每个Web层需要的集合调用Hibernate.initialize()(必须在Session被关闭之前调用)或者通过使用FETCH子句来明确获取到整个集合。 </p>
  </li>
</ul>
<p>你可以使用Hibernate Session API中的filter() 方法来在初始化之前得到集合的大小： </p>
<pre class="code">( (Integer) s.filter( collection, &quot;select count(*)&quot; ).get(0) ).intValue()</pre>
<p>filter() 或者 createFilter()同样被用于有效的重新载入一个集合的子集而不需要载入整个集合。 </p>
<div class="rpindex"><a href="23.html"> 下一页</a><a href="21.html"> 上一页</a><a href="index.html">首页</a></div>


<!-- tail-start -->
﻿
<div style="clear:both;"></div>

</div>
<!--end of file-wrpper-->
</div>
<!--end of content-wrapper-->
</div>
<!--end of container-->


<footer>
<p class="copyright">版权所有 2014 <a href="http://www.iteedu.com">ITEEDU</a>, 京ICP备16069454号</p>
</footer>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

<!--百度统计js-->
<p style="display:none">
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5213b08a76d4fc6b8a80eb382490e0b' type='text/javascript'%3E%3C/script%3E"));
</script>
</p>

</body>

</html>


<!-- tail-end -->
